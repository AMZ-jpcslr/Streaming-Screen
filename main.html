<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Streaming Screen Overlay (OBS)</title>
    <style>
        :root{
            /* Base theme color (requested). Opacity bumped up for better visibility. */
            /* Theme base (requested): RGB(20, 30, 55) */
            --base: rgb(20, 30, 55);
            --accent: rgba(20, 30, 55, 0.55);
            --accent-strong: rgba(20, 30, 55, 0.72);
            --accent-solid: rgba(20, 30, 55, 0.92);
            --fg: #eaeef8;
            --muted: rgba(234,238,248,0.65);
            /* Glass tint should also be based on the theme (avoid white-ish look) */
            --glass: rgba(20, 30, 55, 0.60);
            --glass-2: rgba(20, 30, 55, 0.72);
            --width-game: 1600px;
            --height-game: 900px;
                /* Final canvas target (HD): 1920x1080
                    Game area: 1600x900
                    Right sidebar: 320px  (1600 + 320 = 1920)
                    Bottom bar: 180px     (900 + 180 = 1080)
                */
                --sidebar-w: 320px;
                --bottombar-h: 180px;

            /* Typography (tuned for OBS readability) */
            --font-chat-header: 18px;
            --font-chat-msg: 16px;
            --font-announce: 24px;
            --font-xid: 20px;

            /* Logo: zoom inside the frame (keeps aspect ratio & prevents overflow) */
            --logo-zoom: 1.18;
        }

          /* Make background transparent so OBS can composite.
              NOTE: In normal browsers, a fully-transparent page can look like "nothing is displayed".
              Use ?preview=1 to show a faint background and guide frames. */
          html,body{height:100%;margin:0;background:transparent;font-family:Segoe UI, Roboto, "Helvetica Neue", Arial, sans-serif;color:var(--fg);}

        /* Overall stage matches game + sidebar + bottom bar */
        .stage{
            width: calc(var(--width-game) + var(--sidebar-w));
            height: calc(var(--height-game) + var(--bottombar-h));
            position:relative;
            box-sizing: border-box;
            background: transparent;
        }

        /* Preview mode (browser-friendly). Toggle with ?preview=1 */
    body.preview{background: radial-gradient(1200px 700px at 20% 20%, rgba(20,30,55,0.24), rgba(0,0,0,0.0)), rgba(10,12,18,0.92);}
        body.preview .stage{margin: 18px;}

        /* Left: reserved area (transparent) exactly 1600x900 for the game capture to sit under/next to */
        .game-area{
            width: var(--width-game);
            height: var(--height-game);
            float:left;
            box-sizing:border-box;
            position:relative;
        }

        body.preview .game-area{
            outline: 2px dashed rgba(234,238,248,0.32);
            outline-offset: -6px;
        }

        .corner-label{
            position:absolute;
            left:12px;
            top:12px;
            font-size:12px;
            color: rgba(234,238,248,0.75);
            background: rgba(20, 30, 55, 0.72);
            border: 1px solid rgba(234,238,248,0.08);
            padding: 6px 8px;
            border-radius: 10px;
            display:none;
        }

        body.preview .corner-label{display:inline-block;}

        /* Right sidebar for chat */
        .sidebar{
            position:absolute;
            right:0;
            top:0;
            width:var(--sidebar-w);
            height: calc(var(--height-game) + var(--bottombar-h));
            padding:18px;
            box-sizing:border-box;
            backdrop-filter: blur(6px);
            -webkit-backdrop-filter: blur(6px);
        }

        .chat-card{
            width:100%;
            height:100%;
            background: linear-gradient(180deg, rgba(20, 30, 55, 0.82), rgba(20, 30, 55, 0.62));
            border-radius:14px;
            border:1px solid rgba(234,238,248,0.08);
            padding:12px;
            box-sizing:border-box;
            display:flex;
            flex-direction:column;
            gap:10px;
            outline: 1px solid var(--accent-strong);
            box-shadow: 0 18px 44px rgba(0,0,0,0.22);
        }

        /* Reference-like: sidebar is a continuous panel; header can be hidden */
        .chat-header{display:none;}

        .chat-header{
            font-weight:600;
            font-size:var(--font-chat-header);
            color:var(--muted);
            display:flex;
            align-items:center;
            gap:8px;
        }

        .chat-body{
            flex:1; overflow:auto; padding-right:6px;
            display:flex;flex-direction:column;gap:8px;
        }

        /* Chat bubble style */
        .msg{
            position:relative;
            padding:10px 12px;
            border-radius:14px;
            color:var(--fg);
            font-size:var(--font-chat-msg);
            max-width:100%;
            line-height: 1.38;
            /* Use variables so the tail + decorations can match exactly */
            --bubble-bg: linear-gradient(180deg, rgba(20,30,55,0.78), rgba(20,30,55,0.62));
            --bubble-border: rgba(234,238,248,0.10);
            background: var(--bubble-bg);
            border: 1px solid rgba(234,238,248,0.10);
            box-shadow:
              0 1px 0 rgba(255,255,255,0.03) inset,
              0 10px 24px rgba(0,0,0,0.18);
            transform-origin: left bottom;
            /* allow the offset frame to peek out */
            overflow: visible;
        }

        /* White offset frame behind the bubble (slightly protruding to bottom-right) */
        .msg::after{
            content:'';
            position:absolute;
            inset:0;
            transform: translate(6px, 6px);
            border-radius: inherit;
            background: rgba(255,255,255,0.92);
            border: 1px solid rgba(255,255,255,0.88);
            box-shadow: 0 10px 18px rgba(0,0,0,0.18);
            z-index: -1;
            pointer-events: none;
        }

        /* Bubble tail */
        .msg::before{
            content:'';
            position:absolute;
            left:10px;
            bottom:-6px;
            width:12px;
            height:12px;
            /* Match bubble body exactly (avoid mismatch from 'inherit') */
            background: var(--bubble-bg);
            border-left: 1px solid var(--bubble-border);
            border-bottom: 1px solid var(--bubble-border);
            transform: rotate(45deg);
            border-bottom-left-radius: 3px;
            filter: drop-shadow(0 6px 10px rgba(0,0,0,0.10));
        }

        .msg:nth-child(2n){
            --bubble-bg: linear-gradient(180deg, rgba(20,30,55,0.88), rgba(20,30,55,0.68));
            background: var(--bubble-bg);
        }

        .msg .n{font-weight:900; color: rgba(234,238,248,0.92);}
        .msg .t{
            color: rgba(234,238,248,0.88);
            /* Allow long messages to wrap to multiple lines instead of clipping */
            white-space: normal;
            overflow-wrap: anywhere;
            word-break: break-word;
            hyphens: auto;
        }

        .msg .rb{display:inline-flex; gap:6px; align-items:center;}
        .msg .tag{
            display:inline-flex;
            align-items:center;
            justify-content:center;
            height: 18px;
            min-width: 18px;
            padding: 0 6px;
            border-radius: 999px;
            font-weight: 900;
            font-size: 12px;
            line-height: 18px;
            letter-spacing: 0.1px;
            border: 1px solid rgba(234,238,248,0.16);
            background: rgba(10,12,18,0.35);
            color: rgba(234,238,248,0.92);
            vertical-align: middle;
        }
        .msg .tag.owner{background: rgba(255,196,0,0.18); border-color: rgba(255,196,0,0.35);}
        .msg .tag.mod{background: rgba(92,167,255,0.18); border-color: rgba(92,167,255,0.35);}
        .msg .tag.member{background: rgba(0,214,143,0.16); border-color: rgba(0,214,143,0.30);}

        /* New message animation */
        .msg.in{
            animation: chatIn 240ms ease-out both;
        }

        .msg.flash{
            animation: chatFlash 520ms ease-out both;
        }

        @keyframes chatIn{
            0%{ transform: translateX(12px) translateY(6px) scale(0.86); opacity:0; filter: blur(1.4px); }
            60%{ transform: translateX(0) translateY(0) scale(1.04); opacity:1; filter: blur(0); }
            100%{ transform: translateX(0) translateY(0) scale(1); opacity:1; filter: blur(0); }
        }

        @keyframes chatFlash{
            0%{ box-shadow: 0 0 0 rgba(92,167,255,0.0), 0 10px 24px rgba(0,0,0,0.18); }
            35%{ box-shadow: 0 0 18px rgba(92,167,255,0.28), 0 10px 24px rgba(0,0,0,0.18); }
            100%{ box-shadow: 0 0 0 rgba(92,167,255,0.0), 0 10px 24px rgba(0,0,0,0.18); }
        }

        @media (prefers-reduced-motion: reduce){
            .msg.in, .msg.flash{animation:none !important;}
        }

        /* Bottom bar across full stage */
        .bottom-bar{
            position:absolute;
            left:0; bottom:0;
            width:100%;
            height:var(--bottombar-h);
            display:flex;
            align-items:center;
            gap:12px;
            padding:14px 18px;
            box-sizing:border-box;
            background: var(--accent-solid);
            border-top-left-radius:18px;
            border-top-right-radius:18px;
            border-top:1px solid rgba(255,255,255,0.10);
            box-shadow: 0 -14px 40px rgba(0,0,0,0.24);
        }

        /* Logo: designed to handle wide images like 1080x360 without distortion */
        .logo{
            width:180px; height:60px;
            border-radius:12px;
            overflow:hidden;
            display:flex;align-items:center;justify-content:center;
            /* No frame: show only the image */
            background: transparent;
            border: none;
            padding:6px;
            box-sizing:border-box;
        }

        .clock{
            display:flex;
            align-items:center;
            gap:10px;
            padding:10px 12px;
            border-radius:12px;
            background: rgba(0,0,0,0.10);
            border: 1px solid rgba(255,255,255,0.10);
            color: rgba(234,238,248,0.92);
            font-weight:800;
            font-size: 22px;
            letter-spacing: 0.4px;
            line-height: 1;
            white-space: nowrap;
            user-select: none;
        }

        .chip{
            display:flex;
            align-items:center;
            justify-content:center;
            padding:10px 12px;
            border-radius:12px;
            background: rgba(0,0,0,0.10);
            border: 1px solid rgba(255,255,255,0.10);
            color: rgba(234,238,248,0.92);
            font-weight:800;
            font-size: 18px;
            letter-spacing: 0.2px;
            white-space: nowrap;
            user-select: none;
        }

        .chip.secondary{
            background: rgba(255,255,255,0.08);
            border-color: rgba(255,255,255,0.12);
            color: rgba(234,238,248,0.88);
        }

        .xid-typing{min-width: 180px; justify-content:flex-start;}
        .xid-typing .caret{width:10px; opacity:0.8; animation: caretBlink 900ms step-end infinite;}
        @keyframes caretBlink{50%{opacity:0;}}

        .title-box{
            flex: 0 1 45%;
            height: 52px;
            padding:10px 14px;
            border-radius:12px;
            background: rgba(255,255,255,0.94);
            border: 1px solid rgba(255,255,255,0.18);
            color: rgba(20,30,55,0.92);
            display:flex;
            align-items:center;
            gap:10px;
            min-width: 360px;
            max-width: 45%;
            box-shadow: inset 0 0 0 1px rgba(20,30,55,0.08);
        }

        .title-box .pill{
            font-weight:900;
            font-size: 14px;
            letter-spacing: 0.3px;
            padding:6px 10px;
            border-radius:999px;
            background: rgba(20,30,55,0.10);
            color: rgba(20,30,55,0.86);
            white-space: nowrap;
        }

        .title-box .text{
            font-weight:900;
            font-size: 20px;
            letter-spacing: 0.2px;
            white-space: nowrap;
            overflow:hidden;
            text-overflow: ellipsis;
        }

        /* Title marquee (enabled only when overflowing) */
        .title-box .text.marquee{
            text-overflow: clip;
        }

        .title-box .text.marquee > span{
            display:inline-block;
            padding-left: 100%;
            animation: titleMarquee var(--marquee-dur, 14s) linear infinite;
            will-change: transform;
        }

        @keyframes titleMarquee{
            0%{ transform: translateX(0); }
            100%{ transform: translateX(-100%); }
        }

        .clock .label{
            font-weight:700;
            font-size: 14px;
            letter-spacing: 0.3px;
            opacity: 0.75;
        }

        .clock .time{
            font-variant-numeric: tabular-nums;
        }

        /* Zoom the image slightly for readability, but keep it clipped inside the frame */
        .logo img{width:100%;height:100%;object-fit:contain;display:block;transform:scale(var(--logo-zoom));transform-origin:center center}

        .logo .logo-hint{
            position:absolute;
            inset:0;
            display:flex;
            align-items:flex-start;
            justify-content:flex-start;
            padding:10px 12px;
            text-align:left;
            font-weight:800;
            font-size:12px;
            line-height:1.25;
            color: rgba(234,238,248,0.78);
            border: 1px dashed rgba(234,238,248,0.22);
            border-radius: 12px;
            margin: 10px;
            background: rgba(20,30,55,0.22);
            pointer-events:none;
        }

    /* Legacy fields kept (used by JS); hidden in new layout */
    .announce{display:none;}
    .xid{display:none;}

        /* small responsive helper when showing in browser window */
        @media (max-width:1200px){
            .stage{transform:scale(0.8);transform-origin:top left}
        }

        /* Event notification toast (for SuperChat / Membership etc.) */
        .toast{
            position:absolute;
            left:20px;
            top:20px;
            z-index:50;
            width:min(560px, calc(var(--width-game) - 40px));
            padding:14px 16px;
            border-radius:16px;
            background: rgba(20, 30, 55, 0.92);
            border: 1px solid rgba(234,238,248,0.10);
            box-shadow: 0 18px 54px rgba(0,0,0,0.34);
            display:none;
        }

        .toast.show{display:block; animation: toastIn 220ms ease-out;}

        .toast .t-title{font-weight:800;font-size:20px;letter-spacing:0.2px; margin-bottom:4px;}
        .toast .t-body{font-size:18px;color: rgba(234,238,248,0.86); line-height:1.25;}

        .toast.type-superchat{background: rgba(20, 30, 55, 0.96); outline: 2px solid rgba(255, 196, 0, 0.60);}
        .toast.type-membership{background: rgba(20, 30, 55, 0.96); outline: 2px solid rgba(0, 214, 143, 0.55);}
        .toast.type-gift{background: rgba(20, 30, 55, 0.96); outline: 2px solid rgba(92, 167, 255, 0.55);}

        @keyframes toastIn{
            from{transform:translateY(-10px); opacity:0;}
            to{transform:translateY(0); opacity:1;}
        }

        /* Small auth hint (preview only) */
        .auth-hint{
            position:absolute;
            right:20px;
            top:20px;
            z-index:60;
            width: calc(var(--sidebar-w) - 40px);
            padding:12px 12px;
            background: rgba(20, 30, 55, 0.86);
            border: 1px solid rgba(234,238,248,0.10);
            border-radius: 14px;
            display:none;
            box-shadow: 0 12px 30px rgba(0,0,0,0.28);
        }
        .auth-hint .a-title{font-weight:800;color: rgba(234,238,248,0.90); margin-bottom:6px;}
        .auth-hint .a-body{font-size:14px;color: rgba(234,238,248,0.74); line-height:1.35;}
        .auth-hint a{color: rgba(234,238,248,0.92); font-weight:700; text-decoration: underline;}
        body.preview .auth-hint{display:block;}

        /* Debug/status panel (preview only) */
        .status-panel{
            position:absolute;
            left:20px;
            top:110px;
            z-index:60;
            width:min(560px, calc(var(--width-game) - 40px));
            padding:12px 12px;
            background: rgba(20, 30, 55, 0.84);
            border: 1px solid rgba(234,238,248,0.10);
            border-radius: 16px;
            display:none;
            box-shadow: 0 12px 30px rgba(0,0,0,0.28);
        }
        body.preview .status-panel{display:block;}
        .status-panel .s-title{font-weight:900; margin-bottom:6px;}
        .status-panel .s-grid{display:grid; grid-template-columns: 160px 1fr; gap:4px 10px; font-size:13px;}
        .status-panel .k{color: rgba(234,238,248,0.68);}
        .status-panel .v{color: rgba(234,238,248,0.90); word-break: break-all;}
        .status-panel .badge{display:inline-block; padding:2px 8px; border-radius:999px; font-weight:800; font-size:12px; margin-right:8px;}
        .badge.ok{background: rgba(0, 214, 143, 0.22); border:1px solid rgba(0, 214, 143, 0.35);}
        .badge.ng{background: rgba(255, 92, 92, 0.16); border:1px solid rgba(255, 92, 92, 0.28);}
        .badge.warn{background: rgba(255, 196, 0, 0.16); border:1px solid rgba(255, 196, 0, 0.26);}
    </style>
    <script>
        // Helper: read URL params to customize logo, announcement, xid, and chat iframe
        function qp(name, fallback){
            const url = new URL(window.location.href);
            return url.searchParams.get(name) || fallback;
        }

        function clamp(n, min, max){
            return Math.min(max, Math.max(min, n));
        }

        function updateClock(){
            const el = document.getElementById('clock-time');
            if(!el) return;

            const showSeconds = (qp('seconds','0') === '1');
            const timeZone = qp('tz','');

            const dtf = new Intl.DateTimeFormat('ja-JP', {
                hour: '2-digit',
                minute: '2-digit',
                second: showSeconds ? '2-digit' : undefined,
                hour12: false,
                timeZone: timeZone || undefined,
            });

            el.textContent = dtf.format(new Date());
        }

        function sanitizeText(s){
            // Keep it simple: this overlay only needs plain text.
            return String(s ?? '').replace(/[\r\n\t]+/g, ' ').trim();
        }

        function sleep(ms){
            return new Promise(r=>setTimeout(r, ms));
        }

        async function typeText(el, text, {speedMs=60, startDelayMs=0} = {}){
            if(!el) return;
            const safe = sanitizeText(text);
            el.textContent = '';
            if(startDelayMs) await sleep(startDelayMs);
            for(let i=0;i<safe.length;i++){
                el.textContent += safe[i];
                await sleep(speedMs);
            }
        }

        async function eraseText(el, {speedMs=20} = {}){
            if(!el) return;
            const cur = String(el.textContent || '');
            for(let i=cur.length;i>0;i--){
                el.textContent = cur.slice(0, i-1);
                await sleep(speedMs);
            }
        }

        function startTypingLoop(el, text){
            if(!el) return;

            // cancel previous loop if any
            if(startTypingLoop._token) startTypingLoop._token.canceled = true;
            const token = { canceled:false };
            startTypingLoop._token = token;

            const speedParam = parseInt(qp('typeSpeed',''), 10);
            const eraseSpeedParam = parseInt(qp('eraseSpeed',''), 10);
            const cycleParam = parseInt(qp('typeCycle',''), 10);
            const holdParam = parseInt(qp('typeHold',''), 10);

            const typeSpeed = Number.isFinite(speedParam) ? Math.max(18, Math.min(180, speedParam)) : 55;
            const eraseSpeed = Number.isFinite(eraseSpeedParam) ? Math.max(10, Math.min(120, eraseSpeedParam)) : 20;
            const holdMs = Number.isFinite(holdParam) ? Math.max(500, Math.min(20000, holdParam)) : 4200;
            const cycleMs = Number.isFinite(cycleParam) ? Math.max(2000, Math.min(60000, cycleParam)) : 9000;

            (async ()=>{
                while(!token.canceled){
                    await typeText(el, text, { speedMs: typeSpeed, startDelayMs: 250 });
                    if(token.canceled) break;
                    await sleep(holdMs);
                    if(token.canceled) break;
                    await eraseText(el, { speedMs: eraseSpeed });
                    if(token.canceled) break;
                    // pad the rest of the cycle
                    const waitMs = Math.max(0, cycleMs - holdMs);
                    if(waitMs) await sleep(waitMs);
                }
            })();
        }

        function showToast({title, body, type, ms}){
            const toast = document.getElementById('toast');
            const tTitle = document.getElementById('toast-title');
            const tBody = document.getElementById('toast-body');

            const safeTitle = sanitizeText(title);
            const safeBody = sanitizeText(body);

            tTitle.textContent = safeTitle || 'é€šçŸ¥';
            tBody.textContent = safeBody;

            toast.classList.remove('type-superchat','type-membership','type-gift');
            const t = (type || '').toLowerCase();
            if(t === 'superchat') toast.classList.add('type-superchat');
            else if(t === 'membership') toast.classList.add('type-membership');
            else if(t === 'gift') toast.classList.add('type-gift');

            toast.classList.add('show');
            const dur = Number.isFinite(ms) ? ms : 7000;

            window.clearTimeout(showToast._timer);
            showToast._timer = window.setTimeout(()=>{
                toast.classList.remove('show');
            }, Math.max(800, dur));
        }

        function appendChatMessage({name, text, role, isOwner, isMod, isMember}){
            const chatContainer = document.getElementById('chat-body');
            if(!chatContainer) return;

            // Detect whether user is already near bottom BEFORE appending
            const nearBottom = (chatContainer.scrollHeight - chatContainer.scrollTop - chatContainer.clientHeight) < 40;

            const d = document.createElement('div');
            d.className = 'msg in';

            const rb = document.createElement('span');
            rb.className = 'rb';

            const n = document.createElement('span');
            n.className = 'n';
            n.textContent = sanitizeText(name) || 'åç„¡ã—';

            // role badges
            const r = String(role || '').toLowerCase();
            const showOwner = (r === 'owner') || Boolean(isOwner);
            const showMod = (r === 'mod') || Boolean(isMod);
            const showMember = (r === 'member') || Boolean(isMember);

            if(showOwner){
                const tag = document.createElement('span');
                tag.className = 'tag owner';
                tag.textContent = 'ğŸ‘‘';
                tag.title = 'é…ä¿¡è€…';
                rb.appendChild(tag);
            } else if(showMod){
                const tag = document.createElement('span');
                tag.className = 'tag mod';
                tag.textContent = 'ğŸ”§';
                tag.title = 'ãƒ¢ãƒ‡ãƒ¬ãƒ¼ã‚¿ãƒ¼';
                rb.appendChild(tag);
            } else if(showMember){
                const tag = document.createElement('span');
                tag.className = 'tag member';
                tag.textContent = 'â˜…';
                tag.title = 'ãƒ¡ãƒ³ãƒãƒ¼';
                rb.appendChild(tag);
            }

            rb.appendChild(n);

            const sep = document.createTextNode(': ');

            const t = document.createElement('span');
            t.className = 't';
            t.textContent = sanitizeText(text);

            d.appendChild(rb);
            d.appendChild(sep);
            d.appendChild(t);
            chatContainer.appendChild(d);

            // Add a subtle flash effect after insertion
            window.setTimeout(()=>{
                d.classList.add('flash');
                d.classList.remove('in');
            }, 20);

            // cap messages to keep DOM light
            const MAX = 80;
            while(chatContainer.children.length > MAX){
                chatContainer.removeChild(chatContainer.firstElementChild);
            }

            // auto-scroll if user was at bottom (or close)
            if(nearBottom){
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }
        }

        function startSse(){
            if(!('EventSource' in window)) return;
            try{
                // Ensure we keep only one SSE connection per page.
                if(window.__ss_es){
                    try{ window.__ss_es.close(); }catch(_){ /* ignore */ }
                    window.__ss_es = null;
                }
                const es = new EventSource('/api/events');
                window.__ss_es = es;
                es.addEventListener('yt', (ev)=>{
                    let data = null;
                    try{ data = JSON.parse(ev.data); }catch(_){ return; }
                    if(!data) return;
                    if(data.kind === 'toast'){
                        showToast({ title: data.title, body: data.body, type: data.type, ms: data.ms });
                    } else if(data.kind === 'chat'){
                        appendChatMessage({
                            name: data.name,
                            text: data.text,
                            role: data.role,
                            isOwner: data.isOwner,
                            isMod: data.isMod,
                            isMember: data.isMember
                        });
                    }
                });
                es.onerror = () => {
                    // Silent: in OBS you may not have auth configured.
                };
            } catch(_){
                // ignore
            }
        }

        async function pollStatus(){
            try{
                const [a, y] = await Promise.all([
                    fetch('/api/auth/status', { cache: 'no-store' }),
                    fetch('/api/yt/state', { cache: 'no-store' })
                ]);
                if(!a.ok || !y.ok) return;
                const auth = await a.json();
                const yt = await y.json();

                const el = document.getElementById('status-grid');
                if(!el) return;

                const statusText = (yt?.lastStatus?.message || '').toString();
                const level = (yt?.lastStatus?.level || 'info').toString();
                const oauthOk = !!auth.oauthConfigured;
                const authed = !!auth.authed;
                const hasChat = !!yt.activeLiveChatId;

                const badge = (cls, text) => `<span class="badge ${cls}">${text}</span>`;
                const authBadge = oauthOk ? badge('ok','env OK') : badge('ng','env NG');
                const tokenBadge = authed ? badge('ok','authed') : badge('warn','not authed');
                const chatBadge = hasChat ? badge('ok','live OK') : badge('warn','no live');

                                const ytEnabled = (yt && typeof yt.ytEnabled === 'boolean') ? yt.ytEnabled : false;
                                const enabledBadge = ytEnabled ? badge('ok','YT ON') : badge('warn','YT OFF');
                                const enableHint = ytEnabled
                                    ? ''
                                    : `<div style="margin-top:6px; color: rgba(255,196,0,0.92); font-weight:900;">â€» YT OFF ã®ãŸã‚ YouTube API ã‚’å©ã‹ãšã€ãƒ©ã‚¤ãƒ–æ¤œå‡º/ã‚³ãƒ¡ãƒ³ãƒˆå–å¾—ã¯å‹•ãã¾ã›ã‚“ã€‚</div>`;
                                const toggleHtml = `
                                    <button id="yt-toggle" style="cursor:pointer; padding:6px 10px; border-radius:10px; border:1px solid rgba(234,238,248,0.18); background: rgba(20,30,55,0.55); color: rgba(234,238,248,0.92); font-weight:800;">
                                        ${ytEnabled ? 'ã‚³ãƒ¡ãƒ³ãƒˆå–å¾—ã‚’OFF' : 'ã‚³ãƒ¡ãƒ³ãƒˆå–å¾—ã‚’ON'}
                                    </button>
                                    <span style="margin-left:8px; color: rgba(234,238,248,0.72);">ï¼ˆOFFã ã¨APIã‚’å©ã‹ãšã‚¯ã‚©ãƒ¼ã‚¿æ¶ˆè²»ã—ã¾ã›ã‚“ï¼‰</span>
                                                    ${enableHint}
                                                    ${ytEnabled ? '' : `<div style=\"margin-top:6px;\"><a href=\"/control\" target=\"_blank\" rel=\"noopener\" style=\"color: rgba(234,238,248,0.95); font-weight:900; text-decoration: underline;\">/control</a> ã‹ã‚‰ON/OFFç®¡ç†ã‚‚ã§ãã¾ã™ã€‚</div>`}
                                `;

                const rows = [
                    ['OAuthè¨­å®š', `${authBadge} ${tokenBadge}`],
                                        ['YouTubeå–å¾—', `${enabledBadge} ${toggleHtml}`],
                    ['èªå¯ãƒãƒ£ãƒ³ãƒãƒ«', yt.authedChannel ? `${sanitizeText(yt.authedChannel.title || '(no title)')} (${sanitizeText(yt.authedChannel.id || '?')})` : '-'],
                    ['é…ä¿¡ä¸­ãƒ©ã‚¤ãƒ–', yt.activeBroadcast ? `${sanitizeText(yt.activeBroadcast.title || '(no title)')} (${sanitizeText(yt.activeBroadcast.id || '?')})` : '-'],
                    ['ãƒ©ã‚¤ãƒ–æ¤œå‡º', `${chatBadge}`],
                    ['liveChatId', yt.activeLiveChatId || '-'],
                    ['SSEæ¥ç¶šæ•°', String(yt.sseClients ?? '-')],
                    ['Policy', `<a href="https://amz-jpcslr.github.io/Streaming-Screen/privacy.html" target="_blank" rel="noopener" style="color: rgba(234,238,248,0.95); font-weight:900; text-decoration: underline;">Privacy</a> <span style="margin:0 8px; color: rgba(234,238,248,0.55);">/</span> <a href="https://amz-jpcslr.github.io/Streaming-Screen/terms.html" target="_blank" rel="noopener" style="color: rgba(234,238,248,0.95); font-weight:900; text-decoration: underline;">Terms</a>`],
                    ['è¨ºæ–­', `<a href="/api/yt/diagnose" target="_blank" rel="noopener" style="color: rgba(234,238,248,0.95); font-weight:900; text-decoration: underline;">/api/yt/diagnose</a> <span style="margin-left:10px; color: rgba(234,238,248,0.72);">ï¼ˆåŸå› ã®åˆ‡ã‚Šåˆ†ã‘JSONï¼‰</span>`],
                    ['Polling', `${yt.polling ? 'ON' : 'OFF'} (env=${yt.pollMs ?? '-'}ms / effective=${yt.pollMsEffective ?? '-' }ms)`],
                    ['nextPollAt', yt.nextPollAt || '-'],
                    ['backoffUntil', yt.backoffUntil || '-'],
                    ['lastPollAt', yt.lastPollAt || '-'],
                    ['lastSeenMessageId', yt.lastSeenMessageId || '-'],
                    ['status', `${level.toUpperCase()}: ${sanitizeText(statusText)}`],
                                        [
                                            'hint',
                                            (String(statusText).toLowerCase().includes('live chat is no longer live')
                                                ? 'ãƒ©ã‚¤ãƒ–ãŒçµ‚äº†ã—ãŸ/ãƒãƒ£ãƒƒãƒˆãŒé–‰ã˜ãŸå¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚è‡ªå‹•ã§å†æ¤œå‡ºã—ã¾ã™ã€‚ã—ã°ã‚‰ãå¾…ã£ã¦ã‚‚ç›´ã‚‰ãªã„å ´åˆã¯é…ä¿¡ä¸­ã‹ã‚’ç¢ºèªã—ã€å¿…è¦ãªã‚‰ãƒ­ã‚°ã‚¢ã‚¦ãƒˆâ†’å†èªå¯ã—ã¦ãã ã•ã„ã€‚'
                                                : (String(statusText).toLowerCase().includes('exceeded your quota')
                                                    ? 'YouTube Data API ã®æ—¥æ¬¡ã‚¯ã‚©ãƒ¼ã‚¿è¶…éã§ã™ã€‚backoffUntil ã¾ã§å¾…ã¤ã‹ã€ã‚³ãƒ¡ãƒ³ãƒˆæœ€å„ªå…ˆãªã‚‰ ?chat=... iframe ã«åˆ‡æ›¿ãˆã‚‹ã®ãŒç¢ºå®Ÿã§ã™ã€‚'
                                                    : '-'))
                                        ],
                ];

                el.innerHTML = rows.map(([k,v]) => `<div class="k">${k}</div><div class="v">${v}</div>`).join('');

                // Bind toggle button (re-created each poll)
                const btn = document.getElementById('yt-toggle');
                if(btn){
                    btn.onclick = async () => {
                        try{
                            btn.disabled = true;
                            const resp = await fetch('/api/yt/enabled', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ enabled: !ytEnabled })
                            });
                            if(!resp.ok) throw new Error('toggle failed');
                            // Refresh immediately
                            pollStatus();
                        } catch(e){
                            // ignore
                        } finally {
                            btn.disabled = false;
                        }
                    };
                }
            } catch(_){
                // ignore
            }
        }

        document.addEventListener('DOMContentLoaded', ()=>{
            // Preview mode: shows a faint background + guide frames for local browser viewing
            const preview = (qp('preview','0') === '1');
            if(preview) document.body.classList.add('preview');

            // OBS 1080p mode (backward compatible):
            // The default layout is already designed for 1920x1080.
            const mode = qp('mode','');
            if(mode === '1080'){
                // no-op (kept for old URLs)
            }

            // Optional: control logo zoom from URL (e.g. ?logoZoom=1.25)
            const logoZoomParam = parseFloat(qp('logoZoom',''));
            if(!Number.isNaN(logoZoomParam)){
                document.documentElement.style.setProperty('--logo-zoom', String(clamp(logoZoomParam, 1.0, 1.6)));
            }

            // Optional one-shot notification (useful for testing):
            //   ?notify=Thanks%21&notifyType=superchat
            const notify = qp('notify','');
            const notifyType = qp('notifyType','');
            if(notify){
                showToast({
                    title: notifyType ? notifyType.toUpperCase() : 'é€šçŸ¥',
                    body: decodeURIComponent(notify),
                    type: notifyType,
                    ms: 9000
                });
            }

            // Live notifications from other browser sources (same origin):
            // Sender side example:
            //   const ch = new BroadcastChannel('streaming-screen');
            //   ch.postMessage({type:'superchat', title:'SUPERCHAT', body:'â—¯â—¯ã•ã‚“: Â¥5000 ã‚ã‚ŠãŒã¨ã†ï¼'});
            try{
                const bc = new BroadcastChannel('streaming-screen');
                bc.addEventListener('message', (ev)=>{
                    const msg = ev.data || {};
                    if(msg && (msg.body || msg.title)){
                        showToast({
                            title: msg.title || 'é€šçŸ¥',
                            body: msg.body || '',
                            type: msg.type || '',
                            ms: Number(msg.ms) || 7000
                        });
                    }
                });
            } catch(e){
                // Some environments may not support BroadcastChannel.
            }

            // Server-driven notifications (SSE) for YouTube events
            // - Requires server-side OAuth setup
            startSse();

            // Preview-only status panel
            if(preview){
                pollStatus();
                window.setInterval(pollStatus, 2500);
            }

            // Clock: update immediately + keep it accurate.
            updateClock();
            window.setInterval(updateClock, 1000);

            // Set text fields
            async function applyOverlaySettings(){
                // Read saved defaults from server (optional). URL params have priority.
                let saved = {};
                try{
                    const r = await fetch('/api/settings', { cache: 'no-store' });
                    if(r.ok) saved = await r.json();
                } catch(_){
                    // ignore
                }

                const chan = qp('channel','Channel Name');

                const announce = qp('announce', (typeof saved.announce === 'string' && saved.announce) ? saved.announce : 'ä»Šæ—¥ã¯ã¾ã£ãŸã‚Šæ”»ç•¥é…ä¿¡ï¼ã‚³ãƒ¡ãƒ³ãƒˆå¤§æ­“è¿');
                const xid = qp('xid', (typeof saved.xid === 'string' && saved.xid) ? saved.xid : '@streaming_screen');
                const logo = qp('logo', (typeof saved.logo === 'string') ? saved.logo : '');
                const chatUrl = qp('chat', (typeof saved.chat === 'string') ? saved.chat : '');

                const fanart = qp('fanart', (typeof saved.fanart === 'string' && saved.fanart) ? saved.fanart : '#ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒ¼ãƒˆ');

                // Legacy nodes (kept for compatibility)
                document.getElementById('announce').textContent = announce;
                document.getElementById('xid').textContent = xid;

                // New bottom-bar nodes
                const titleEl = document.getElementById('title-text');
                if(titleEl) titleEl.textContent = announce;

                const fanartEl = document.getElementById('fanart');
                if(fanartEl) fanartEl.textContent = fanart;

                const xidTypeTarget = document.getElementById('xid-typed');
                if(xidTypeTarget){
                    // Loop typing animation: type -> hold -> erase -> repeat
                    startTypingLoop(xidTypeTarget, xid);
                }

                // Title marquee: if it's long, scroll right -> left like a station board
                const titleNode = document.getElementById('title-text');
                if(titleNode){
                    // Reset to raw text first
                    const raw = String(announce || '');
                    titleNode.classList.remove('marquee');
                    titleNode.textContent = raw;

                    // Measure after layout
                    requestAnimationFrame(()=>{
                        const overflowing = titleNode.scrollWidth > titleNode.clientWidth + 4;
                        if(!overflowing) return;

                        titleNode.innerHTML = '';
                        const span = document.createElement('span');
                        span.textContent = raw;
                        titleNode.appendChild(span);
                        titleNode.classList.add('marquee');

                        // duration based on length (configurable)
                        const base = parseFloat(qp('marqueeBase',''));
                        const perChar = parseFloat(qp('marqueePerChar',''));
                        const dur = (Number.isFinite(base) ? base : 8) + (Number.isFinite(perChar) ? perChar : 0.22) * raw.length;
                        titleNode.style.setProperty('--marquee-dur', Math.max(8, Math.min(40, dur)).toFixed(2) + 's');
                    });
                }

                const savedZoom = (typeof saved.logoZoom !== 'undefined' && saved.logoZoom !== null) ? Number(saved.logoZoom) : NaN;
                if(qp('logoZoom','') === '' && !Number.isNaN(savedZoom)){
                    document.documentElement.style.setProperty('--logo-zoom', String(clamp(savedZoom, 1.0, 1.6)));
                }

                const logoImg = document.getElementById('logo-img');
                const logoHint = document.getElementById('logo-hint');
                if(logo){
                    logoImg.src = decodeURIComponent(logo);
                    logoImg.alt = chan + ' logo';
                    logoImg.style.display = '';
                    if(logoHint) logoHint.style.display = 'none';
                } else {
                    // In preview, show an empty placeholder with a short instruction.
                    // In non-preview, keep the logo area empty unless user explicitly sets it.
                    logoImg.removeAttribute('src');
                    logoImg.alt = '';
                    logoImg.style.display = 'none';
                    if(logoHint) logoHint.style.display = preview ? '' : 'none';
                }

                // Chat handling:
                // - If ?chat is provided, use iframe (legacy/external chat embed)
                // - Otherwise, this pane will be filled by YouTube API (SSE) after OAuth
                const chatContainer = document.getElementById('chat-body');
                if(chatUrl){
                    // Use provided chat URL (encoded allowed)
                    const iframe = document.createElement('iframe');
                    iframe.src = decodeURIComponent(chatUrl);
                    iframe.style.border='0'; iframe.style.width='100%'; iframe.style.height='100%'; iframe.style.borderRadius='8px';
                    iframe.allow = 'microphone; camera; autoplay';
                    chatContainer.innerHTML='';
                    chatContainer.appendChild(iframe);
                } else {
                    // No chat URL provided: keep it empty.
                    // In preview mode, show a small hint so it's obvious nothing is broken.
                    chatContainer.innerHTML = '';
                    if(preview){
                        const hint = document.createElement('div');
                        hint.className = 'msg';
                        hint.textContent = 'YouTubeèªå¯å¾Œã€ã“ã®æ ã«ã‚³ãƒ¡ãƒ³ãƒˆãŒæµã‚Œã¾ã™ï¼ˆã¾ãŸã¯ ?chat=... ã§iframeè¡¨ç¤ºï¼‰';
                        chatContainer.appendChild(hint);
                    }
                }
            }

            applyOverlaySettings();
        });
    </script>
</head>
<body>
    <div class="stage" role="presentation">
        <div class="auth-hint" aria-hidden="true">
            <div class="a-title">YouTubeé€šçŸ¥ï¼ˆè‡ªä½œAPIé€£æºï¼‰</div>
            <div class="a-body">
                ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ä¸­ã«ã€YouTubeã®èªè¨¼ã‚’æ¸ˆã¾ã›ã‚‹ã¨<br>
                ã‚¹ãƒ¼ãƒ‘ãƒ¼ãƒãƒ£ãƒƒãƒˆ/ãƒ¡ãƒ³ãƒãƒ¼é€šçŸ¥ã‚’è¡¨ç¤ºã§ãã¾ã™ã€‚<br>
                <a href="/api/auth/start" target="_blank" rel="noopener">YouTubeã«ãƒ­ã‚°ã‚¤ãƒ³ï¼ˆèªå¯ï¼‰</a>
            </div>
        </div>
        <div id="toast" class="toast" aria-live="polite" aria-atomic="true">
            <div id="toast-title" class="t-title">é€šçŸ¥</div>
            <div id="toast-body" class="t-body"></div>
        </div>

        <div class="status-panel" aria-hidden="true">
            <div class="s-title">ãƒ‡ãƒãƒƒã‚° / ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼ˆpreviewã®ã¿ï¼‰</div>
            <div id="status-grid" class="s-grid"></div>
        </div>
        <div class="game-area" aria-hidden="true">
            <div class="corner-label">GAME AREA (1600Ã—900) / ã“ã“ã«ã‚²ãƒ¼ãƒ æ˜ åƒ</div>
            <!-- Transparent reserved area: place your game capture in OBS below/left so it fills this 1600x900 region -->
        </div>

        <div class="sidebar" aria-label="chat sidebar">
            <div class="chat-card">
                <div class="chat-header">Chat</div>
                <div id="chat-body" class="chat-body">
                    <!-- JS will either place an iframe here (if ?chat=...) or sample messages -->
                </div>
            </div>
        </div>

        <div class="bottom-bar" aria-label="stream info bar">
            <div class="logo">
                <img id="logo-img" src="" alt="logo">
                <div id="logo-hint" class="logo-hint" style="display:none;">ã“ã“ã«ç”»åƒã‚’è²¼ã‚Œã¾ã™<br>ï¼ˆç®¡ç†ãƒšãƒ¼ã‚¸ã§ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼‰</div>
            </div>
            <div class="clock" aria-label="current time">
                <div class="label">NOW</div>
                <div class="time" id="clock-time">--:--</div>
            </div>

            <div class="chip xid-typing" aria-label="x id">
                <span id="xid-typed">@your_x_id</span><span class="caret">|</span>
            </div>
            <div class="chip secondary" aria-label="fanart tag">
                <span id="fanart">#fanart</span>
            </div>
            <div class="title-box" aria-label="stream title">
                <div class="pill">Title</div>
                <div class="text" id="title-text">Welcome to the stream!</div>
            </div>

            <!-- Legacy nodes (hidden by CSS). Keep IDs so existing JS stays compatible. -->
            <div class="announce" id="announce">Welcome to the stream! Enjoy your stay.</div>
            <div class="xid" id="xid">@your_x_id</div>
        </div>
    </div>
</body>
</html>
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Streaming Screen Overlay (OBS)</title>
    <style>
        :root{
            /* Base theme color (requested). Opacity bumped up for better visibility. */
            /* Theme base (requested): RGB(20, 30, 55) */
            --base: rgb(20, 30, 55);
            --accent: rgba(20, 30, 55, 0.55);
            --accent-strong: rgba(20, 30, 55, 0.72);
            --accent-solid: rgba(20, 30, 55, 0.92);
            --fg: #eaeef8;
            --muted: rgba(234,238,248,0.65);
            /* Glass tint should also be based on the theme (avoid white-ish look) */
            --glass: rgba(20, 30, 55, 0.60);
            --glass-2: rgba(20, 30, 55, 0.72);
            --width-game: 1600px;
            --height-game: 900px;
                /* Final canvas target (HD): 1920x1080
                    Game area: 1600x900
                    Right sidebar: 320px  (1600 + 320 = 1920)
                    Bottom bar: 180px     (900 + 180 = 1080)
                */
                --sidebar-w: 320px;
                --bottombar-h: 180px;

            /* Typography (tuned for OBS readability) */
            --font-chat-header: 18px;
            --font-chat-msg: 16px;
            --font-announce: 24px;
            --font-xid: 20px;

            /* Logo: zoom inside the frame (keeps aspect ratio & prevents overflow) */
            --logo-zoom: 1.18;
        }

          /* Make background transparent so OBS can composite.
              NOTE: In normal browsers, a fully-transparent page can look like "nothing is displayed".
              Use ?preview=1 to show a faint background and guide frames. */
          html,body{height:100%;margin:0;background:transparent;font-family:Segoe UI, Roboto, "Helvetica Neue", Arial, sans-serif;color:var(--fg);}

        /* Overall stage matches game + sidebar + bottom bar */
        .stage{
            width: calc(var(--width-game) + var(--sidebar-w));
            height: calc(var(--height-game) + var(--bottombar-h));
            position:relative;
            box-sizing: border-box;
            background: transparent;
        }

        /* Preview mode (browser-friendly). Toggle with ?preview=1 */
    body.preview{background: radial-gradient(1200px 700px at 20% 20%, rgba(20,30,55,0.24), rgba(0,0,0,0.0)), rgba(10,12,18,0.92);}
        body.preview .stage{margin: 18px;}

        /* Left: reserved area (transparent) exactly 1600x900 for the game capture to sit under/next to */
        .game-area{
            width: var(--width-game);
            height: var(--height-game);
            float:left;
            box-sizing:border-box;
            position:relative;
        }

        body.preview .game-area{
            outline: 2px dashed rgba(234,238,248,0.32);
            outline-offset: -6px;
        }

        .corner-label{
            position:absolute;
            left:12px;
            top:12px;
            font-size:12px;
            color: rgba(234,238,248,0.75);
            background: rgba(20, 30, 55, 0.72);
            border: 1px solid rgba(234,238,248,0.08);
            padding: 6px 8px;
            border-radius: 10px;
            display:none;
        }

        body.preview .corner-label{display:inline-block;}

        /* Right sidebar for chat */
        .sidebar{
            position:absolute;
            right:0;
            top:0;
            width:var(--sidebar-w);
            height:var(--height-game);
            padding:18px;
            box-sizing:border-box;
            backdrop-filter: blur(6px);
            -webkit-backdrop-filter: blur(6px);
        }

        .chat-card{
            width:100%;
            height:100%;
            background: linear-gradient(180deg, rgba(20, 30, 55, 0.82), rgba(20, 30, 55, 0.62));
            border-radius:14px;
            border:1px solid rgba(234,238,248,0.08);
            padding:12px;
            box-sizing:border-box;
            display:flex;
            flex-direction:column;
            gap:10px;
            outline: 1px solid var(--accent-strong);
            box-shadow: 0 18px 44px rgba(0,0,0,0.22);
        }

        .chat-header{
            font-weight:600;
            font-size:var(--font-chat-header);
            color:var(--muted);
            display:flex;
            align-items:center;
            gap:8px;
        }

        .chat-body{
            flex:1; overflow:auto; padding-right:6px;
            display:flex;flex-direction:column;gap:8px;
        }

        .msg{
            padding:10px 12px; border-radius:10px; background:var(--glass); color:var(--fg); font-size:var(--font-chat-msg); max-width:100%;
            line-height: 1.35;
            box-shadow: 0 1px 0 rgba(255,255,255,0.02) inset;
        }

        .msg:nth-child(2n){
            background: var(--glass-2);
        }

        /* Bottom bar across full stage */
        .bottom-bar{
            position:absolute;
            left:0; bottom:0;
            width:100%;
            height:var(--bottombar-h);
            display:flex;align-items:center;gap:18px;
            padding:12px 20px; box-sizing:border-box;
            /* Flat solid color (no gradient) */
            background: var(--accent-solid);
            border-top-left-radius:18px;
            border-top-right-radius:0;
            border-top:1px solid rgba(255,255,255,0.10);
            box-shadow: 0 -14px 40px rgba(0,0,0,0.24);
        }

        /* Logo: designed to handle wide images like 1080x360 without distortion */
        .logo{
            width:180px; height:60px;
            border-radius:12px;
            overflow:hidden;
            display:flex;align-items:center;justify-content:center;
            /* No frame: show only the image */
            background: transparent;
            border: none;
            padding:6px;
            box-sizing:border-box;
        }

        /* Zoom the image slightly for readability, but keep it clipped inside the frame */
        .logo img{width:100%;height:100%;object-fit:contain;display:block;transform:scale(var(--logo-zoom));transform-origin:center center}

    .announce{flex:1; font-size:var(--font-announce); color:var(--fg); opacity:0.98; letter-spacing: 0.2px;}

    .xid{font-weight:700;color: rgba(234,238,248,0.78); font-size:var(--font-xid); min-width:260px;text-align:right}

        /* small responsive helper when showing in browser window */
        @media (max-width:1200px){
            .stage{transform:scale(0.8);transform-origin:top left}
        }

        /* Event notification toast (for SuperChat / Membership etc.) */
        .toast{
            position:absolute;
            left:20px;
            top:20px;
            z-index:50;
            width:min(560px, calc(var(--width-game) - 40px));
            padding:14px 16px;
            border-radius:16px;
            background: rgba(20, 30, 55, 0.92);
            border: 1px solid rgba(234,238,248,0.10);
            box-shadow: 0 18px 54px rgba(0,0,0,0.34);
            display:none;
        }

        .toast.show{display:block; animation: toastIn 220ms ease-out;}

        .toast .t-title{font-weight:800;font-size:20px;letter-spacing:0.2px; margin-bottom:4px;}
        .toast .t-body{font-size:18px;color: rgba(234,238,248,0.86); line-height:1.25;}

        .toast.type-superchat{background: rgba(20, 30, 55, 0.96); outline: 2px solid rgba(255, 196, 0, 0.60);}
        .toast.type-membership{background: rgba(20, 30, 55, 0.96); outline: 2px solid rgba(0, 214, 143, 0.55);}
        .toast.type-gift{background: rgba(20, 30, 55, 0.96); outline: 2px solid rgba(92, 167, 255, 0.55);}

        @keyframes toastIn{
            from{transform:translateY(-10px); opacity:0;}
            to{transform:translateY(0); opacity:1;}
        }

        /* Small auth hint (preview only) */
        .auth-hint{
            position:absolute;
            right:20px;
            top:20px;
            z-index:60;
            width: calc(var(--sidebar-w) - 40px);
            padding:12px 12px;
            background: rgba(20, 30, 55, 0.86);
            border: 1px solid rgba(234,238,248,0.10);
            border-radius: 14px;
            display:none;
            box-shadow: 0 12px 30px rgba(0,0,0,0.28);
        }
        .auth-hint .a-title{font-weight:800;color: rgba(234,238,248,0.90); margin-bottom:6px;}
        .auth-hint .a-body{font-size:14px;color: rgba(234,238,248,0.74); line-height:1.35;}
        .auth-hint a{color: rgba(234,238,248,0.92); font-weight:700; text-decoration: underline;}
        body.preview .auth-hint{display:block;}

        /* Debug/status panel (preview only) */
        .status-panel{
            position:absolute;
            left:20px;
            top:110px;
            z-index:60;
            width:min(560px, calc(var(--width-game) - 40px));
            padding:12px 12px;
            background: rgba(20, 30, 55, 0.84);
            border: 1px solid rgba(234,238,248,0.10);
            border-radius: 16px;
            display:none;
            box-shadow: 0 12px 30px rgba(0,0,0,0.28);
        }
        body.preview .status-panel{display:block;}
        .status-panel .s-title{font-weight:900; margin-bottom:6px;}
        .status-panel .s-grid{display:grid; grid-template-columns: 160px 1fr; gap:4px 10px; font-size:13px;}
        .status-panel .k{color: rgba(234,238,248,0.68);}
        .status-panel .v{color: rgba(234,238,248,0.90); word-break: break-all;}
        .status-panel .badge{display:inline-block; padding:2px 8px; border-radius:999px; font-weight:800; font-size:12px; margin-right:8px;}
        .badge.ok{background: rgba(0, 214, 143, 0.22); border:1px solid rgba(0, 214, 143, 0.35);}
        .badge.ng{background: rgba(255, 92, 92, 0.16); border:1px solid rgba(255, 92, 92, 0.28);}
        .badge.warn{background: rgba(255, 196, 0, 0.16); border:1px solid rgba(255, 196, 0, 0.26);}
    </style>
    <script>
        // Helper: read URL params to customize logo, announcement, xid, and chat iframe
        function qp(name, fallback){
            const url = new URL(window.location.href);
            return url.searchParams.get(name) || fallback;
        }

        function clamp(n, min, max){
            return Math.min(max, Math.max(min, n));
        }

        function sanitizeText(s){
            // Keep it simple: this overlay only needs plain text.
            return String(s ?? '').replace(/[\r\n\t]+/g, ' ').trim();
        }

        function showToast({title, body, type, ms}){
            const toast = document.getElementById('toast');
            const tTitle = document.getElementById('toast-title');
            const tBody = document.getElementById('toast-body');

            const safeTitle = sanitizeText(title);
            const safeBody = sanitizeText(body);

            tTitle.textContent = safeTitle || '通知';
            tBody.textContent = safeBody;

            toast.classList.remove('type-superchat','type-membership','type-gift');
            const t = (type || '').toLowerCase();
            if(t === 'superchat') toast.classList.add('type-superchat');
            else if(t === 'membership') toast.classList.add('type-membership');
            else if(t === 'gift') toast.classList.add('type-gift');

            toast.classList.add('show');
            const dur = Number.isFinite(ms) ? ms : 7000;

            window.clearTimeout(showToast._timer);
            showToast._timer = window.setTimeout(()=>{
                toast.classList.remove('show');
            }, Math.max(800, dur));
        }

        function appendChatMessage({name, text}){
            const chatContainer = document.getElementById('chat-body');
            if(!chatContainer) return;

            // Detect whether user is already near bottom BEFORE appending
            const nearBottom = (chatContainer.scrollHeight - chatContainer.scrollTop - chatContainer.clientHeight) < 40;

            const d = document.createElement('div');
            d.className = 'msg';
            d.textContent = `${sanitizeText(name)}: ${sanitizeText(text)}`;
            chatContainer.appendChild(d);

            // cap messages to keep DOM light
            const MAX = 80;
            while(chatContainer.children.length > MAX){
                chatContainer.removeChild(chatContainer.firstElementChild);
            }

            // auto-scroll if user was at bottom (or close)
            if(nearBottom){
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }
        }

        function startSse(){
            if(!('EventSource' in window)) return;
            try{
                const es = new EventSource('/api/events');
                es.addEventListener('yt', (ev)=>{
                    let data = null;
                    try{ data = JSON.parse(ev.data); }catch(_){ return; }
                    if(!data) return;
                    if(data.kind === 'toast'){
                        showToast({ title: data.title, body: data.body, type: data.type, ms: data.ms });
                    } else if(data.kind === 'chat'){
                        appendChatMessage({ name: data.name, text: data.text });
                    }
                });
                es.onerror = () => {
                    // Silent: in OBS you may not have auth configured.
                };
            } catch(_){
                // ignore
            }
        }

        async function pollStatus(){
            try{
                const [a, y] = await Promise.all([
                    fetch('/api/auth/status', { cache: 'no-store' }),
                    fetch('/api/yt/state', { cache: 'no-store' })
                ]);
                if(!a.ok || !y.ok) return;
                const auth = await a.json();
                const yt = await y.json();

                const el = document.getElementById('status-grid');
                if(!el) return;

                const statusText = (yt?.lastStatus?.message || '').toString();
                const level = (yt?.lastStatus?.level || 'info').toString();
                const oauthOk = !!auth.oauthConfigured;
                const authed = !!auth.authed;
                const hasChat = !!yt.activeLiveChatId;

                const badge = (cls, text) => `<span class="badge ${cls}">${text}</span>`;
                const authBadge = oauthOk ? badge('ok','env OK') : badge('ng','env NG');
                const tokenBadge = authed ? badge('ok','authed') : badge('warn','not authed');
                const chatBadge = hasChat ? badge('ok','live OK') : badge('warn','no live');

                const rows = [
                    ['OAuth設定', `${authBadge} ${tokenBadge}`],
                    ['ライブ検出', `${chatBadge}`],
                    ['liveChatId', yt.activeLiveChatId || '-'],
                    ['SSE接続数', String(yt.sseClients ?? '-')],
                    ['Polling', `${yt.polling ? 'ON' : 'OFF'} (${yt.pollMs ?? '-'}ms)`],
                    ['lastPollAt', yt.lastPollAt || '-'],
                    ['lastSeenMessageId', yt.lastSeenMessageId || '-'],
                    ['status', `${level.toUpperCase()}: ${sanitizeText(statusText)}`],
                ];

                el.innerHTML = rows.map(([k,v]) => `<div class="k">${k}</div><div class="v">${v}</div>`).join('');
            } catch(_){
                // ignore
            }
        }

        document.addEventListener('DOMContentLoaded', ()=>{
            // Preview mode: shows a faint background + guide frames for local browser viewing
            const preview = (qp('preview','0') === '1');
            if(preview) document.body.classList.add('preview');

            // OBS 1080p mode (backward compatible):
            // The default layout is already designed for 1920x1080.
            const mode = qp('mode','');
            if(mode === '1080'){
                // no-op (kept for old URLs)
            }

            // Optional: control logo zoom from URL (e.g. ?logoZoom=1.25)
            const logoZoomParam = parseFloat(qp('logoZoom',''));
            if(!Number.isNaN(logoZoomParam)){
                document.documentElement.style.setProperty('--logo-zoom', String(clamp(logoZoomParam, 1.0, 1.6)));
            }

            // Optional one-shot notification (useful for testing):
            //   ?notify=Thanks%21&notifyType=superchat
            const notify = qp('notify','');
            const notifyType = qp('notifyType','');
            if(notify){
                showToast({
                    title: notifyType ? notifyType.toUpperCase() : '通知',
                    body: decodeURIComponent(notify),
                    type: notifyType,
                    ms: 9000
                });
            }

            // Live notifications from other browser sources (same origin):
            // Sender side example:
            //   const ch = new BroadcastChannel('streaming-screen');
            //   ch.postMessage({type:'superchat', title:'SUPERCHAT', body:'◯◯さん: ¥5000 ありがとう！'});
            try{
                const bc = new BroadcastChannel('streaming-screen');
                bc.addEventListener('message', (ev)=>{
                    const msg = ev.data || {};
                    if(msg && (msg.body || msg.title)){
                        showToast({
                            title: msg.title || '通知',
                            body: msg.body || '',
                            type: msg.type || '',
                            ms: Number(msg.ms) || 7000
                        });
                    }
                });
            } catch(e){
                // Some environments may not support BroadcastChannel.
            }

            // Server-driven notifications (SSE) for YouTube events
            // - Requires server-side OAuth setup
            startSse();

            // Preview-only status panel
            if(preview){
                pollStatus();
                window.setInterval(pollStatus, 2500);
            }

            // Set text fields
            const chan = qp('channel','Channel Name');
            const announce = qp('announce','はの【ゲーム実況】チャンネルにようこそ！');
            const xid = qp('xid','@hano_game');
            const logo = qp('logo','');
            const chatUrl = qp('chat','');

            document.getElementById('announce').textContent = announce;
            document.getElementById('xid').textContent = xid;

            const logoImg = document.getElementById('logo-img');
            if(logo){
                logoImg.src = decodeURIComponent(logo);
                logoImg.alt = chan + ' logo';
            } else {
                // Default logo from local assets
                logoImg.src = './assets/logo.jpg';
                logoImg.alt = chan + ' logo';
            }

            // Chat handling:
            // - If ?chat is provided, use iframe (legacy/external chat embed)
            // - Otherwise, this pane will be filled by YouTube API (SSE) after OAuth
            const chatContainer = document.getElementById('chat-body');
            if(chatUrl){
                // Use provided chat URL (encoded allowed)
                const iframe = document.createElement('iframe');
                iframe.src = decodeURIComponent(chatUrl);
                iframe.style.border='0'; iframe.style.width='100%'; iframe.style.height='100%'; iframe.style.borderRadius='8px';
                iframe.allow = 'microphone; camera; autoplay';
                chatContainer.innerHTML='';
                chatContainer.appendChild(iframe);
            } else {
                // No chat URL provided: keep it empty.
                // In preview mode, show a small hint so it's obvious nothing is broken.
                chatContainer.innerHTML = '';
                if(preview){
                    const hint = document.createElement('div');
                    hint.className = 'msg';
                    hint.textContent = 'YouTube認可後、この枠にコメントが流れます（または ?chat=... でiframe表示）';
                    chatContainer.appendChild(hint);
                }
            }
        });
    </script>
</head>
<body>
    <div class="stage" role="presentation">
        <div class="auth-hint" aria-hidden="true">
            <div class="a-title">YouTube通知（自作API連携）</div>
            <div class="a-body">
                プレビュー中に、YouTubeの認証を済ませると<br>
                スーパーチャット/メンバー通知を表示できます。<br>
                <a href="/api/auth/start" target="_blank" rel="noopener">YouTubeにログイン（認可）</a>
            </div>
        </div>
        <div id="toast" class="toast" aria-live="polite" aria-atomic="true">
            <div id="toast-title" class="t-title">通知</div>
            <div id="toast-body" class="t-body"></div>
        </div>

        <div class="status-panel" aria-hidden="true">
            <div class="s-title">デバッグ / ステータス（previewのみ）</div>
            <div id="status-grid" class="s-grid"></div>
        </div>
        <div class="game-area" aria-hidden="true">
            <div class="corner-label">GAME AREA (1600×900) / ここにゲーム映像</div>
            <!-- Transparent reserved area: place your game capture in OBS below/left so it fills this 1600x900 region -->
        </div>

        <div class="sidebar" aria-label="chat sidebar">
            <div class="chat-card">
                <div class="chat-header">Chat</div>
                <div id="chat-body" class="chat-body">
                    <!-- JS will either place an iframe here (if ?chat=...) or sample messages -->
                </div>
            </div>
        </div>

        <div class="bottom-bar" aria-label="stream info bar">
            <div class="logo"><img id="logo-img" src="" alt="logo"></div>
            <div class="announce" id="announce">Welcome to the stream! Enjoy your stay.</div>
            <div class="xid" id="xid">@your_x_id</div>
        </div>
    </div>
</body>
</html>
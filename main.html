<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Streaming Screen Overlay (OBS)</title>
    <style>
        :root{
            /* Base theme color (requested). Opacity bumped up for better visibility. */
            /* Theme base (requested): RGB(20, 30, 55) */
            --base: rgb(20, 30, 55);
            --accent: rgba(20, 30, 55, 0.55);
            --accent-strong: rgba(20, 30, 55, 0.72);
            --accent-solid: rgba(20, 30, 55, 0.92);
            --fg: #eaeef8;
            --muted: rgba(234,238,248,0.65);
            /* Glass tint should also be based on the theme (avoid white-ish look) */
            --glass: rgba(20, 30, 55, 0.60);
            --glass-2: rgba(20, 30, 55, 0.72);
            --width-game: 1600px;
            --height-game: 900px;
                /* Final canvas target (HD): 1920x1080
                    Game area: 1600x900
                    Right sidebar: 320px  (1600 + 320 = 1920)
                    Bottom bar: 180px     (900 + 180 = 1080)
                */
                --sidebar-w: 320px;
                --bottombar-h: 180px;

            /* Typography (tuned for OBS readability) */
            --font-chat-header: 18px;
            --font-chat-msg: 16px;
            --font-announce: 24px;
            --font-xid: 20px;

            /* Logo: zoom inside the frame (keeps aspect ratio & prevents overflow) */
            --logo-zoom: 1.18;
        }

          /* Make background transparent so OBS can composite.
              NOTE: In normal browsers, a fully-transparent page can look like "nothing is displayed".
              Use ?preview=1 to show a faint background and guide frames. */
          html,body{height:100%;margin:0;background:transparent;font-family:Segoe UI, Roboto, "Helvetica Neue", Arial, sans-serif;color:var(--fg);}

        /* Overall stage matches game + sidebar + bottom bar */
        .stage{
            width: calc(var(--width-game) + var(--sidebar-w));
            height: calc(var(--height-game) + var(--bottombar-h));
            position:relative;
            box-sizing: border-box;
            background: transparent;
        }

        /* Preview mode (browser-friendly). Toggle with ?preview=1 */
    body.preview{background: radial-gradient(1200px 700px at 20% 20%, rgba(20,30,55,0.24), rgba(0,0,0,0.0)), rgba(10,12,18,0.92);}
        body.preview .stage{margin: 18px;}

        /* Left: reserved area (transparent) exactly 1600x900 for the game capture to sit under/next to */
        .game-area{
            width: var(--width-game);
            height: var(--height-game);
            float:left;
            box-sizing:border-box;
            position:relative;
        }

        body.preview .game-area{
            outline: 2px dashed rgba(234,238,248,0.32);
            outline-offset: -6px;
        }

        .corner-label{
            position:absolute;
            left:12px;
            top:12px;
            font-size:12px;
            color: rgba(234,238,248,0.75);
            background: rgba(20, 30, 55, 0.72);
            border: 1px solid rgba(234,238,248,0.08);
            padding: 6px 8px;
            border-radius: 10px;
            display:none;
        }

        body.preview .corner-label{display:inline-block;}

        /* Right sidebar for chat */
        .sidebar{
            position:absolute;
            right:0;
            top:0;
            width:var(--sidebar-w);
            height:var(--height-game);
            padding:18px;
            box-sizing:border-box;
            backdrop-filter: blur(6px);
            -webkit-backdrop-filter: blur(6px);
        }

        .chat-card{
            width:100%;
            height:100%;
            background: linear-gradient(180deg, rgba(20, 30, 55, 0.82), rgba(20, 30, 55, 0.62));
            border-radius:14px;
            border:1px solid rgba(234,238,248,0.08);
            padding:12px;
            box-sizing:border-box;
            display:flex;
            flex-direction:column;
            gap:10px;
            outline: 1px solid var(--accent-strong);
            box-shadow: 0 18px 44px rgba(0,0,0,0.22);
        }

        .chat-header{
            font-weight:600;
            font-size:var(--font-chat-header);
            color:var(--muted);
            display:flex;
            align-items:center;
            gap:8px;
        }

        .chat-body{
            flex:1; overflow:auto; padding-right:6px;
            display:flex;flex-direction:column;gap:8px;
        }

        /* Chat bubble style */
        .msg{
            position:relative;
            padding:10px 12px;
            border-radius:14px;
            color:var(--fg);
            font-size:var(--font-chat-msg);
            max-width:100%;
            line-height: 1.38;
            background: linear-gradient(180deg, rgba(20,30,55,0.78), rgba(20,30,55,0.62));
            border: 1px solid rgba(234,238,248,0.10);
            box-shadow:
              0 1px 0 rgba(255,255,255,0.03) inset,
              0 10px 24px rgba(0,0,0,0.18);
            transform-origin: left bottom;
        }

        /* Bubble tail */
        .msg::before{
            content:'';
            position:absolute;
            left:10px;
            bottom:-6px;
            width:12px;
            height:12px;
            background: inherit;
            border-left: 1px solid rgba(234,238,248,0.10);
            border-bottom: 1px solid rgba(234,238,248,0.10);
            transform: rotate(45deg);
            border-bottom-left-radius: 3px;
            filter: drop-shadow(0 6px 10px rgba(0,0,0,0.10));
        }

        .msg:nth-child(2n){
            background: linear-gradient(180deg, rgba(20,30,55,0.88), rgba(20,30,55,0.68));
        }

        .msg .n{font-weight:900; color: rgba(234,238,248,0.92);}
        .msg .t{color: rgba(234,238,248,0.88);}

        .msg .rb{display:inline-flex; gap:6px; align-items:center;}
        .msg .tag{
            display:inline-flex;
            align-items:center;
            justify-content:center;
            height: 18px;
            min-width: 18px;
            padding: 0 6px;
            border-radius: 999px;
            font-weight: 900;
            font-size: 12px;
            line-height: 18px;
            letter-spacing: 0.1px;
            border: 1px solid rgba(234,238,248,0.16);
            background: rgba(10,12,18,0.35);
            color: rgba(234,238,248,0.92);
            vertical-align: middle;
        }
        .msg .tag.owner{background: rgba(255,196,0,0.18); border-color: rgba(255,196,0,0.35);}
        .msg .tag.mod{background: rgba(92,167,255,0.18); border-color: rgba(92,167,255,0.35);}
        .msg .tag.member{background: rgba(0,214,143,0.16); border-color: rgba(0,214,143,0.30);}

        /* New message animation */
        .msg.in{
            animation: chatIn 240ms ease-out both;
        }

        .msg.flash{
            animation: chatFlash 520ms ease-out both;
        }

        @keyframes chatIn{
            0%{ transform: translateX(12px) translateY(6px) scale(0.86); opacity:0; filter: blur(1.4px); }
            60%{ transform: translateX(0) translateY(0) scale(1.04); opacity:1; filter: blur(0); }
            100%{ transform: translateX(0) translateY(0) scale(1); opacity:1; filter: blur(0); }
        }

        @keyframes chatFlash{
            0%{ box-shadow: 0 0 0 rgba(92,167,255,0.0), 0 10px 24px rgba(0,0,0,0.18); }
            35%{ box-shadow: 0 0 18px rgba(92,167,255,0.28), 0 10px 24px rgba(0,0,0,0.18); }
            100%{ box-shadow: 0 0 0 rgba(92,167,255,0.0), 0 10px 24px rgba(0,0,0,0.18); }
        }

        @media (prefers-reduced-motion: reduce){
            .msg.in, .msg.flash{animation:none !important;}
        }

        /* Bottom bar across full stage */
        .bottom-bar{
            position:absolute;
            left:0; bottom:0;
            width:100%;
            height:var(--bottombar-h);
            display:flex;align-items:center;gap:18px;
            padding:12px 20px; box-sizing:border-box;
            /* Flat solid color (no gradient) */
            background: var(--accent-solid);
            border-top-left-radius:18px;
            border-top-right-radius:0;
            border-top:1px solid rgba(255,255,255,0.10);
            box-shadow: 0 -14px 40px rgba(0,0,0,0.24);
        }

        /* Logo: designed to handle wide images like 1080x360 without distortion */
        .logo{
            width:180px; height:60px;
            border-radius:12px;
            overflow:hidden;
            display:flex;align-items:center;justify-content:center;
            /* No frame: show only the image */
            background: transparent;
            border: none;
            padding:6px;
            box-sizing:border-box;
        }

        /* Zoom the image slightly for readability, but keep it clipped inside the frame */
        .logo img{width:100%;height:100%;object-fit:contain;display:block;transform:scale(var(--logo-zoom));transform-origin:center center}

    .announce{flex:1; font-size:var(--font-announce); color:var(--fg); opacity:0.98; letter-spacing: 0.2px;}

    .xid{font-weight:700;color: rgba(234,238,248,0.78); font-size:var(--font-xid); min-width:260px;text-align:right}

        /* small responsive helper when showing in browser window */
        @media (max-width:1200px){
            .stage{transform:scale(0.8);transform-origin:top left}
        }

        /* Event notification toast (for SuperChat / Membership etc.) */
        .toast{
            position:absolute;
            left:20px;
            top:20px;
            z-index:50;
            width:min(560px, calc(var(--width-game) - 40px));
            padding:14px 16px;
            border-radius:16px;
            background: rgba(20, 30, 55, 0.92);
            border: 1px solid rgba(234,238,248,0.10);
            box-shadow: 0 18px 54px rgba(0,0,0,0.34);
            display:none;
        }

        .toast.show{display:block; animation: toastIn 220ms ease-out;}

        .toast .t-title{font-weight:800;font-size:20px;letter-spacing:0.2px; margin-bottom:4px;}
        .toast .t-body{font-size:18px;color: rgba(234,238,248,0.86); line-height:1.25;}

        .toast.type-superchat{background: rgba(20, 30, 55, 0.96); outline: 2px solid rgba(255, 196, 0, 0.60);}
        .toast.type-membership{background: rgba(20, 30, 55, 0.96); outline: 2px solid rgba(0, 214, 143, 0.55);}
        .toast.type-gift{background: rgba(20, 30, 55, 0.96); outline: 2px solid rgba(92, 167, 255, 0.55);}

        @keyframes toastIn{
            from{transform:translateY(-10px); opacity:0;}
            to{transform:translateY(0); opacity:1;}
        }

        /* Small auth hint (preview only) */
        .auth-hint{
            position:absolute;
            right:20px;
            top:20px;
            z-index:60;
            width: calc(var(--sidebar-w) - 40px);
            padding:12px 12px;
            background: rgba(20, 30, 55, 0.86);
            border: 1px solid rgba(234,238,248,0.10);
            border-radius: 14px;
            display:none;
            box-shadow: 0 12px 30px rgba(0,0,0,0.28);
        }
        .auth-hint .a-title{font-weight:800;color: rgba(234,238,248,0.90); margin-bottom:6px;}
        .auth-hint .a-body{font-size:14px;color: rgba(234,238,248,0.74); line-height:1.35;}
        .auth-hint a{color: rgba(234,238,248,0.92); font-weight:700; text-decoration: underline;}
        body.preview .auth-hint{display:block;}

        /* Debug/status panel (preview only) */
        .status-panel{
            position:absolute;
            left:20px;
            top:110px;
            z-index:60;
            width:min(560px, calc(var(--width-game) - 40px));
            padding:12px 12px;
            background: rgba(20, 30, 55, 0.84);
            border: 1px solid rgba(234,238,248,0.10);
            border-radius: 16px;
            display:none;
            box-shadow: 0 12px 30px rgba(0,0,0,0.28);
        }
        body.preview .status-panel{display:block;}
        .status-panel .s-title{font-weight:900; margin-bottom:6px;}
        .status-panel .s-grid{display:grid; grid-template-columns: 160px 1fr; gap:4px 10px; font-size:13px;}
        .status-panel .k{color: rgba(234,238,248,0.68);}
        .status-panel .v{color: rgba(234,238,248,0.90); word-break: break-all;}
        .status-panel .badge{display:inline-block; padding:2px 8px; border-radius:999px; font-weight:800; font-size:12px; margin-right:8px;}
        .badge.ok{background: rgba(0, 214, 143, 0.22); border:1px solid rgba(0, 214, 143, 0.35);}
        .badge.ng{background: rgba(255, 92, 92, 0.16); border:1px solid rgba(255, 92, 92, 0.28);}
        .badge.warn{background: rgba(255, 196, 0, 0.16); border:1px solid rgba(255, 196, 0, 0.26);}
    </style>
    <script>
        // Helper: read URL params to customize logo, announcement, xid, and chat iframe
        function qp(name, fallback){
            const url = new URL(window.location.href);
            return url.searchParams.get(name) || fallback;
        }

        function clamp(n, min, max){
            return Math.min(max, Math.max(min, n));
        }

        function sanitizeText(s){
            // Keep it simple: this overlay only needs plain text.
            return String(s ?? '').replace(/[\r\n\t]+/g, ' ').trim();
        }

        function showToast({title, body, type, ms}){
            const toast = document.getElementById('toast');
            const tTitle = document.getElementById('toast-title');
            const tBody = document.getElementById('toast-body');

            const safeTitle = sanitizeText(title);
            const safeBody = sanitizeText(body);

            tTitle.textContent = safeTitle || 'ÈÄöÁü•';
            tBody.textContent = safeBody;

            toast.classList.remove('type-superchat','type-membership','type-gift');
            const t = (type || '').toLowerCase();
            if(t === 'superchat') toast.classList.add('type-superchat');
            else if(t === 'membership') toast.classList.add('type-membership');
            else if(t === 'gift') toast.classList.add('type-gift');

            toast.classList.add('show');
            const dur = Number.isFinite(ms) ? ms : 7000;

            window.clearTimeout(showToast._timer);
            showToast._timer = window.setTimeout(()=>{
                toast.classList.remove('show');
            }, Math.max(800, dur));
        }

        function appendChatMessage({name, text, role, isOwner, isMod, isMember}){
            const chatContainer = document.getElementById('chat-body');
            if(!chatContainer) return;

            // Detect whether user is already near bottom BEFORE appending
            const nearBottom = (chatContainer.scrollHeight - chatContainer.scrollTop - chatContainer.clientHeight) < 40;

            const d = document.createElement('div');
            d.className = 'msg in';

            const rb = document.createElement('span');
            rb.className = 'rb';

            const n = document.createElement('span');
            n.className = 'n';
            n.textContent = sanitizeText(name) || 'ÂêçÁÑ°„Åó';

            // role badges
            const r = String(role || '').toLowerCase();
            const showOwner = (r === 'owner') || Boolean(isOwner);
            const showMod = (r === 'mod') || Boolean(isMod);
            const showMember = (r === 'member') || Boolean(isMember);

            if(showOwner){
                const tag = document.createElement('span');
                tag.className = 'tag owner';
                tag.textContent = 'üëë';
                tag.title = 'ÈÖç‰ø°ËÄÖ';
                rb.appendChild(tag);
            } else if(showMod){
                const tag = document.createElement('span');
                tag.className = 'tag mod';
                tag.textContent = 'üîß';
                tag.title = '„É¢„Éá„É¨„Éº„Çø„Éº';
                rb.appendChild(tag);
            } else if(showMember){
                const tag = document.createElement('span');
                tag.className = 'tag member';
                tag.textContent = '‚òÖ';
                tag.title = '„É°„É≥„Éê„Éº';
                rb.appendChild(tag);
            }

            rb.appendChild(n);

            const sep = document.createTextNode(': ');

            const t = document.createElement('span');
            t.className = 't';
            t.textContent = sanitizeText(text);

            d.appendChild(rb);
            d.appendChild(sep);
            d.appendChild(t);
            chatContainer.appendChild(d);

            // Add a subtle flash effect after insertion
            window.setTimeout(()=>{
                d.classList.add('flash');
                d.classList.remove('in');
            }, 20);

            // cap messages to keep DOM light
            const MAX = 80;
            while(chatContainer.children.length > MAX){
                chatContainer.removeChild(chatContainer.firstElementChild);
            }

            // auto-scroll if user was at bottom (or close)
            if(nearBottom){
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }
        }

        function startSse(){
            if(!('EventSource' in window)) return;
            try{
                const es = new EventSource('/api/events');
                es.addEventListener('yt', (ev)=>{
                    let data = null;
                    try{ data = JSON.parse(ev.data); }catch(_){ return; }
                    if(!data) return;
                    if(data.kind === 'toast'){
                        showToast({ title: data.title, body: data.body, type: data.type, ms: data.ms });
                    } else if(data.kind === 'chat'){
                        appendChatMessage({
                            name: data.name,
                            text: data.text,
                            role: data.role,
                            isOwner: data.isOwner,
                            isMod: data.isMod,
                            isMember: data.isMember
                        });
                    }
                });
                es.onerror = () => {
                    // Silent: in OBS you may not have auth configured.
                };
            } catch(_){
                // ignore
            }
        }

        async function pollStatus(){
            try{
                const [a, y] = await Promise.all([
                    fetch('/api/auth/status', { cache: 'no-store' }),
                    fetch('/api/yt/state', { cache: 'no-store' })
                ]);
                if(!a.ok || !y.ok) return;
                const auth = await a.json();
                const yt = await y.json();

                const el = document.getElementById('status-grid');
                if(!el) return;

                const statusText = (yt?.lastStatus?.message || '').toString();
                const level = (yt?.lastStatus?.level || 'info').toString();
                const oauthOk = !!auth.oauthConfigured;
                const authed = !!auth.authed;
                const hasChat = !!yt.activeLiveChatId;

                const badge = (cls, text) => `<span class="badge ${cls}">${text}</span>`;
                const authBadge = oauthOk ? badge('ok','env OK') : badge('ng','env NG');
                const tokenBadge = authed ? badge('ok','authed') : badge('warn','not authed');
                const chatBadge = hasChat ? badge('ok','live OK') : badge('warn','no live');

                                const ytEnabled = (yt && typeof yt.ytEnabled === 'boolean') ? yt.ytEnabled : false;
                                const enabledBadge = ytEnabled ? badge('ok','YT ON') : badge('warn','YT OFF');
                                const toggleHtml = `
                                    <button id="yt-toggle" style="cursor:pointer; padding:6px 10px; border-radius:10px; border:1px solid rgba(234,238,248,0.18); background: rgba(20,30,55,0.55); color: rgba(234,238,248,0.92); font-weight:800;">
                                        ${ytEnabled ? '„Ç≥„É°„É≥„ÉàÂèñÂæó„ÇíOFF' : '„Ç≥„É°„É≥„ÉàÂèñÂæó„ÇíON'}
                                    </button>
                                    <span style="margin-left:8px; color: rgba(234,238,248,0.72);">ÔºàOFF„Å†„Å®API„ÇíÂè©„Åã„Åö„ÇØ„Ç©„Éº„ÇøÊ∂àË≤ª„Åó„Åæ„Åõ„ÇìÔºâ</span>
                                `;

                const rows = [
                    ['OAuthË®≠ÂÆö', `${authBadge} ${tokenBadge}`],
                                        ['YouTubeÂèñÂæó', `${enabledBadge} ${toggleHtml}`],
                    ['Ë™çÂèØ„ÉÅ„É£„É≥„Éç„É´', yt.authedChannel ? `${sanitizeText(yt.authedChannel.title || '(no title)')} (${sanitizeText(yt.authedChannel.id || '?')})` : '-'],
                    ['ÈÖç‰ø°‰∏≠„É©„Ç§„Éñ', yt.activeBroadcast ? `${sanitizeText(yt.activeBroadcast.title || '(no title)')} (${sanitizeText(yt.activeBroadcast.id || '?')})` : '-'],
                    ['„É©„Ç§„ÉñÊ§úÂá∫', `${chatBadge}`],
                    ['liveChatId', yt.activeLiveChatId || '-'],
                    ['SSEÊé•Á∂öÊï∞', String(yt.sseClients ?? '-')],
                    ['Polling', `${yt.polling ? 'ON' : 'OFF'} (env=${yt.pollMs ?? '-'}ms / effective=${yt.pollMsEffective ?? '-' }ms)`],
                    ['nextPollAt', yt.nextPollAt || '-'],
                    ['backoffUntil', yt.backoffUntil || '-'],
                    ['lastPollAt', yt.lastPollAt || '-'],
                    ['lastSeenMessageId', yt.lastSeenMessageId || '-'],
                    ['status', `${level.toUpperCase()}: ${sanitizeText(statusText)}`],
                                        [
                                            'hint',
                                            (String(statusText).toLowerCase().includes('live chat is no longer live')
                                                ? '„É©„Ç§„Éñ„ÅåÁµÇ‰∫Ü„Åó„Åü/„ÉÅ„É£„ÉÉ„Éà„ÅåÈñâ„Åò„ÅüÂèØËÉΩÊÄß„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇËá™Âãï„ÅßÂÜçÊ§úÂá∫„Åó„Åæ„Åô„ÄÇ„Åó„Å∞„Çâ„ÅèÂæÖ„Å£„Å¶„ÇÇÁõ¥„Çâ„Å™„ÅÑÂ†¥Âêà„ÅØÈÖç‰ø°‰∏≠„Åã„ÇíÁ¢∫Ë™ç„Åó„ÄÅÂøÖË¶Å„Å™„Çâ„É≠„Ç∞„Ç¢„Ç¶„Éà‚ÜíÂÜçË™çÂèØ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ'
                                                : (String(statusText).toLowerCase().includes('exceeded your quota')
                                                    ? 'YouTube Data API „ÅÆÊó•Ê¨°„ÇØ„Ç©„Éº„ÇøË∂ÖÈÅé„Åß„Åô„ÄÇbackoffUntil „Åæ„ÅßÂæÖ„Å§„Åã„ÄÅ„Ç≥„É°„É≥„ÉàÊúÄÂÑ™ÂÖà„Å™„Çâ ?chat=... iframe „Å´ÂàáÊõø„Åà„Çã„ÅÆ„ÅåÁ¢∫ÂÆü„Åß„Åô„ÄÇ'
                                                    : '-'))
                                        ],
                ];

                el.innerHTML = rows.map(([k,v]) => `<div class="k">${k}</div><div class="v">${v}</div>`).join('');

                // Bind toggle button (re-created each poll)
                const btn = document.getElementById('yt-toggle');
                if(btn){
                    btn.onclick = async () => {
                        try{
                            btn.disabled = true;
                            const resp = await fetch('/api/yt/enabled', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ enabled: !ytEnabled })
                            });
                            if(!resp.ok) throw new Error('toggle failed');
                            // Refresh immediately
                            pollStatus();
                        } catch(e){
                            // ignore
                        } finally {
                            btn.disabled = false;
                        }
                    };
                }
            } catch(_){
                // ignore
            }
        }

        document.addEventListener('DOMContentLoaded', ()=>{
            // Preview mode: shows a faint background + guide frames for local browser viewing
            const preview = (qp('preview','0') === '1');
            if(preview) document.body.classList.add('preview');

            // OBS 1080p mode (backward compatible):
            // The default layout is already designed for 1920x1080.
            const mode = qp('mode','');
            if(mode === '1080'){
                // no-op (kept for old URLs)
            }

            // Optional: control logo zoom from URL (e.g. ?logoZoom=1.25)
            const logoZoomParam = parseFloat(qp('logoZoom',''));
            if(!Number.isNaN(logoZoomParam)){
                document.documentElement.style.setProperty('--logo-zoom', String(clamp(logoZoomParam, 1.0, 1.6)));
            }

            // Optional one-shot notification (useful for testing):
            //   ?notify=Thanks%21&notifyType=superchat
            const notify = qp('notify','');
            const notifyType = qp('notifyType','');
            if(notify){
                showToast({
                    title: notifyType ? notifyType.toUpperCase() : 'ÈÄöÁü•',
                    body: decodeURIComponent(notify),
                    type: notifyType,
                    ms: 9000
                });
            }

            // Live notifications from other browser sources (same origin):
            // Sender side example:
            //   const ch = new BroadcastChannel('streaming-screen');
            //   ch.postMessage({type:'superchat', title:'SUPERCHAT', body:'‚óØ‚óØ„Åï„Çì: ¬•5000 „ÅÇ„Çä„Åå„Å®„ÅÜÔºÅ'});
            try{
                const bc = new BroadcastChannel('streaming-screen');
                bc.addEventListener('message', (ev)=>{
                    const msg = ev.data || {};
                    if(msg && (msg.body || msg.title)){
                        showToast({
                            title: msg.title || 'ÈÄöÁü•',
                            body: msg.body || '',
                            type: msg.type || '',
                            ms: Number(msg.ms) || 7000
                        });
                    }
                });
            } catch(e){
                // Some environments may not support BroadcastChannel.
            }

            // Server-driven notifications (SSE) for YouTube events
            // - Requires server-side OAuth setup
            startSse();

            // Preview-only status panel
            if(preview){
                pollStatus();
                window.setInterval(pollStatus, 2500);
            }

            // Set text fields
            async function applyOverlaySettings(){
                // Read saved defaults from server (optional). URL params have priority.
                let saved = {};
                try{
                    const r = await fetch('/api/settings', { cache: 'no-store' });
                    if(r.ok) saved = await r.json();
                } catch(_){
                    // ignore
                }

                const chan = qp('channel','Channel Name');

                const announce = qp('announce', (typeof saved.announce === 'string' && saved.announce) ? saved.announce : '„ÅØ„ÅÆ„Äê„Ç≤„Éº„É†ÂÆüÊ≥Å„Äë„ÉÅ„É£„É≥„Éç„É´„Å´„Çà„ÅÜ„Åì„ÅùÔºÅ');
                const xid = qp('xid', (typeof saved.xid === 'string' && saved.xid) ? saved.xid : '@hano_game');
                const logo = qp('logo', (typeof saved.logo === 'string') ? saved.logo : '');
                const chatUrl = qp('chat', (typeof saved.chat === 'string') ? saved.chat : '');

                document.getElementById('announce').textContent = announce;
                document.getElementById('xid').textContent = xid;

                const savedZoom = (typeof saved.logoZoom !== 'undefined' && saved.logoZoom !== null) ? Number(saved.logoZoom) : NaN;
                if(qp('logoZoom','') === '' && !Number.isNaN(savedZoom)){
                    document.documentElement.style.setProperty('--logo-zoom', String(clamp(savedZoom, 1.0, 1.6)));
                }

                const logoImg = document.getElementById('logo-img');
                if(logo){
                    logoImg.src = decodeURIComponent(logo);
                    logoImg.alt = chan + ' logo';
                } else {
                    // Default logo from local assets
                    logoImg.src = './assets/logo.jpg';
                    logoImg.alt = chan + ' logo';
                }

                // Chat handling:
                // - If ?chat is provided, use iframe (legacy/external chat embed)
                // - Otherwise, this pane will be filled by YouTube API (SSE) after OAuth
                const chatContainer = document.getElementById('chat-body');
                if(chatUrl){
                    // Use provided chat URL (encoded allowed)
                    const iframe = document.createElement('iframe');
                    iframe.src = decodeURIComponent(chatUrl);
                    iframe.style.border='0'; iframe.style.width='100%'; iframe.style.height='100%'; iframe.style.borderRadius='8px';
                    iframe.allow = 'microphone; camera; autoplay';
                    chatContainer.innerHTML='';
                    chatContainer.appendChild(iframe);
                } else {
                    // No chat URL provided: keep it empty.
                    // In preview mode, show a small hint so it's obvious nothing is broken.
                    chatContainer.innerHTML = '';
                    if(preview){
                        const hint = document.createElement('div');
                        hint.className = 'msg';
                        hint.textContent = 'YouTubeË™çÂèØÂæå„ÄÅ„Åì„ÅÆÊû†„Å´„Ç≥„É°„É≥„Éà„ÅåÊµÅ„Çå„Åæ„ÅôÔºà„Åæ„Åü„ÅØ ?chat=... „ÅßiframeË°®Á§∫Ôºâ';
                        chatContainer.appendChild(hint);
                    }
                }
            }

            applyOverlaySettings();
        });
    </script>
</head>
<body>
    <div class="stage" role="presentation">
        <div class="auth-hint" aria-hidden="true">
            <div class="a-title">YouTubeÈÄöÁü•ÔºàËá™‰ΩúAPIÈÄ£Êê∫Ôºâ</div>
            <div class="a-body">
                „Éó„É¨„Éì„É•„Éº‰∏≠„Å´„ÄÅYouTube„ÅÆË™çË®º„ÇíÊ∏à„Åæ„Åõ„Çã„Å®<br>
                „Çπ„Éº„Éë„Éº„ÉÅ„É£„ÉÉ„Éà/„É°„É≥„Éê„ÉºÈÄöÁü•„ÇíË°®Á§∫„Åß„Åç„Åæ„Åô„ÄÇ<br>
                <a href="/api/auth/start" target="_blank" rel="noopener">YouTube„Å´„É≠„Ç∞„Ç§„É≥ÔºàË™çÂèØÔºâ</a>
            </div>
        </div>
        <div id="toast" class="toast" aria-live="polite" aria-atomic="true">
            <div id="toast-title" class="t-title">ÈÄöÁü•</div>
            <div id="toast-body" class="t-body"></div>
        </div>

        <div class="status-panel" aria-hidden="true">
            <div class="s-title">„Éá„Éê„ÉÉ„Ç∞ / „Çπ„ÉÜ„Éº„Çø„ÇπÔºàpreview„ÅÆ„ÅøÔºâ</div>
            <div id="status-grid" class="s-grid"></div>
        </div>
        <div class="game-area" aria-hidden="true">
            <div class="corner-label">GAME AREA (1600√ó900) / „Åì„Åì„Å´„Ç≤„Éº„É†Êò†ÂÉè</div>
            <!-- Transparent reserved area: place your game capture in OBS below/left so it fills this 1600x900 region -->
        </div>

        <div class="sidebar" aria-label="chat sidebar">
            <div class="chat-card">
                <div class="chat-header">Chat</div>
                <div id="chat-body" class="chat-body">
                    <!-- JS will either place an iframe here (if ?chat=...) or sample messages -->
                </div>
            </div>
        </div>

        <div class="bottom-bar" aria-label="stream info bar">
            <div class="logo"><img id="logo-img" src="" alt="logo"></div>
            <div class="announce" id="announce">Welcome to the stream! Enjoy your stay.</div>
            <div class="xid" id="xid">@your_x_id</div>
        </div>
    </div>
</body>
</html>
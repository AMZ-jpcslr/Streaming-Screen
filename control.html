<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Streaming-Screen Control</title>
  <style>
    :root{
      --bg: #0b0f1a;
      --card: rgba(20,30,55,0.78);
      --card2: rgba(20,30,55,0.62);
      --fg: #eaeef8;
      --muted: rgba(234,238,248,0.72);
      --line: rgba(234,238,248,0.12);
      --ok: rgba(0,214,143,0.35);
      --warn: rgba(255,196,0,0.28);
      --ng: rgba(255,92,92,0.26);
    }
    html,body{height:100%;margin:0;background:radial-gradient(1200px 700px at 20% 15%, rgba(20,30,55,0.30), rgba(0,0,0,0)), var(--bg);color:var(--fg);font-family:Segoe UI, Roboto, "Helvetica Neue", Arial, sans-serif;}
    .wrap{max-width:980px;margin:0 auto;padding:22px 18px 40px;}
    h1{margin:0 0 10px;font-size:22px;letter-spacing:0.2px;}
    .sub{color:var(--muted);margin:0 0 18px;font-size:13px;line-height:1.4;}
    .grid{display:grid;grid-template-columns: 1fr;gap:14px;}
    @media(min-width:900px){.grid{grid-template-columns: 1fr 1fr;}}
    .card{background:linear-gradient(180deg,var(--card),var(--card2));border:1px solid var(--line);border-radius:16px;box-shadow:0 18px 44px rgba(0,0,0,0.28);padding:14px 14px;}
    .card h2{margin:0 0 10px;font-size:16px;}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin:8px 0;}
    .label{min-width:140px;color:var(--muted);font-size:13px;}
    .value{font-size:13px;word-break:break-all;}
    .badge{display:inline-block;padding:3px 10px;border-radius:999px;font-weight:800;font-size:12px;border:1px solid var(--line)}
    .badge.ok{background:var(--ok)}
    .badge.warn{background:var(--warn)}
    .badge.ng{background:var(--ng)}
    button{cursor:pointer;padding:9px 12px;border-radius:12px;border:1px solid rgba(234,238,248,0.18);background:rgba(20,30,55,0.55);color:rgba(234,238,248,0.95);font-weight:800;}
    button:disabled{opacity:0.6;cursor:not-allowed}
    input,textarea{width:100%;box-sizing:border-box;padding:10px 12px;border-radius:12px;border:1px solid rgba(234,238,248,0.18);background:rgba(10,12,18,0.55);color:rgba(234,238,248,0.95);}
    textarea{min-height:84px;resize:vertical}
    .help{color:var(--muted);font-size:12px;line-height:1.35}
    .full{grid-column:1/-1}
    .actions{display:flex;gap:10px;flex-wrap:wrap}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}

    /* Toast / notice */
    .notice{
      position: fixed;
      right: 16px;
      bottom: 16px;
      z-index: 9999;
      width: min(520px, calc(100vw - 32px));
      padding: 12px 12px;
      border-radius: 14px;
      border: 1px solid rgba(234,238,248,0.14);
      background: rgba(20,30,55,0.92);
      box-shadow: 0 18px 44px rgba(0,0,0,0.35);
      display: none;
    }
    .notice.show{display:block; animation: nIn 180ms ease-out;}
    .notice .n-title{font-weight:900; margin:0 0 4px; font-size:14px;}
    .notice .n-body{margin:0; font-size:13px; color: rgba(234,238,248,0.82); line-height:1.35;}
    .notice.ok{outline:2px solid rgba(0,214,143,0.36);}
    .notice.warn{outline:2px solid rgba(255,196,0,0.28);}
    .notice.ng{outline:2px solid rgba(255,92,92,0.26);}
    @keyframes nIn{from{transform:translateY(10px); opacity:0;} to{transform:translateY(0); opacity:1;}}
    @media (prefers-reduced-motion: reduce){.notice.show{animation:none;}}
  </style>
</head>
<body>
  <div id="notice" class="notice" aria-live="polite" aria-atomic="true">
    <div id="notice-title" class="n-title">-</div>
    <p id="notice-body" class="n-body">-</p>
  </div>

  <div class="wrap">
    <h1>管理ページ（Control）</h1>
    <p class="sub">
      コメント取得のON/OFF（クォータ消費を防ぐ）と、配信画面URLの生成をここで行えます。<br>
      このページ自体は認証なしなので、URLの共有とID、パスワードの管理には十分注意してください。
    </p>

    <div class="grid">
      <div class="card">
        <h2>YouTubeコメント取得</h2>
        <div class="row">
          <span id="badge-enabled" class="badge warn">YT OFF</span>
          <button id="btn-toggle">読み込み中…</button>
        </div>
        <div class="row">
          <div class="label">OAuth設定</div>
          <div class="value" id="st-env">-</div>
        </div>
        <div class="row">
          <div class="label">認可状態</div>
          <div class="value" id="st-authed">-</div>
        </div>
        <div class="row">
          <div class="label">認可チャンネル</div>
          <div class="value" id="st-channel">-</div>
        </div>
        <div class="row">
          <div class="label">配信中ライブ</div>
          <div class="value" id="st-live">-</div>
        </div>
        <div class="row">
          <div class="label">backoffUntil</div>
          <div class="value mono" id="st-backoff">-</div>
        </div>
        <div class="row">
          <div class="label">status</div>
          <div class="value" id="st-status">-</div>
        </div>
        <div class="actions">
          <a href="/api/auth/start" target="_blank" rel="noopener"><button type="button">YouTubeにログイン（認可）</button></a>
          <a href="/?preview=1" target="_blank" rel="noopener"><button type="button">配信画面をプレビュー</button></a>
        </div>
        <p class="help">
          配信していない時は <b>OFF</b> にしておくと、サーバがYouTube Data APIを叩かないのでクォータを消費しません。<br>
          配信開始前後だけ <b>ON</b> にすると安定します。1日に合計で最大8時間のライブ配信のコメント取得に対応しています。
        </p>
      </div>

      <div class="card">
        <h2>配信画面URLジェネレータ</h2>
        <div class="row"><div class="label">お知らせ（announce）</div></div>
        <textarea id="f-announce" placeholder="例：今日は〇〇やります！"></textarea>

        <div class="row"><div class="label">X ID（xid）</div></div>
  <input id="f-xid" placeholder="例：@streaming_screen" />

  <div class="row"><div class="label">ファンアートタグ（fanart）</div></div>
  <input id="f-fanart" placeholder="例：#スクリーンアート" />

        <div class="row"><div class="label">ロゴURL（logo）</div></div>
        <input id="f-logo" placeholder="例：https://example.com/logo.png（空なら assets/logo.jpg）" />

        <div class="row"><div class="label">ロゴ画像アップロード</div></div>
        <input id="f-logoFile" type="file" accept="image/*" />
        <div class="actions">
          <button id="btn-upload-logo" type="button">ロゴをアップロード</button>
        </div>
        <p class="help">
          画像をアップロードすると、サーバ内に保存され、<span class="mono">logo</span> 欄へ自動でURLが入ります。<br>
          そのまま「この内容を保存」を押すと、配信画面のデフォルトロゴとして使われます。
        </p>

        <div class="row"><div class="label">ロゴ拡大（logoZoom）</div></div>
        <input id="f-logoZoom" placeholder="例：1.18" />

        <div class="row"><div class="label">チャットiframe（chat）</div></div>
        <input id="f-chat" placeholder="例：https://www.youtube.com/live_chat?v=VIDEO_ID&embed_domain=..." />
        <p class="help">
          コメント最優先でクォータを使いたくない場合は、ここに chat URL を入れてください（iframe表示が優先されます）。
        </p>

        <div class="actions">
          <button id="btn-save">この内容を保存</button>
          <button id="btn-build">URLを生成</button>
          <button id="btn-open" disabled>生成URLを開く</button>
          <button id="btn-copy" disabled>コピー</button>
        </div>

        <p class="help">生成されたURL：</p>
        <input id="out-url" class="mono" readonly />
      </div>

      <div class="card full">
        <h2>使い方（管理ページ / プレビュー / OBS）</h2>
        <p class="help">
          <b>1} 管理ページ（このページ）</b><br>
          ・配信していない時は「YouTubeコメント取得」を <b>OFF</b> にしてコメント取得に必要なapiの過剰消費を防止できます。<br>
          ・「お知らせ / X ID / ファンアートタグ / ロゴ / チャットURL」を入力して <b>保存</b> すると、配信画面のデフォルト値として使われます。<br>
          ・「URLを生成」は、入力内容をURLパラメータにして即共有したい場合に使います（保存より優先されます）。<br>
          <br>
          <b>2) プレビュー</b><br>
          ・<span class="mono">https://streaming-screen-production.up.railway.app/control/?preview=1</span> を開くと、ガイド枠と状態パネル付きで確認できます（背景も見えるようにしています）。管理画面の「配信画面をプレビュー」ボタンからも開けます。<br>
          <br>
          <b>3) OBSでの使い方（BrowserSource）</b><br>
          ・ソース追加 → ブラウザ → URLに <span class="mono">https://streaming-screen-production.up.railway.app/control/</span>（配信画面）を指定します。<br>
          ・推奨サイズ：<span class="mono">1920 x 1080</span>。このサイズだとデフォルトの空白に1600 x 900の画面がぴったり入ります。背景は透過なので、ゲーム映像の上に重ねられます。<br>
          ・配信中のみ「YouTubeコメント取得」をONにし、必要に応じてyoutubeアカウントへのログイン（認可）を行ってください。
          ・2025/12/25現在GoogleにこのサイトにおけるGoogleアカウントログインの審査を依頼中です。審査完了まではログイン時に「このアプリは Google で確認されていません」と表示されますが、ライブ配信上でのコメント取得目的のみでGoogleアカウントを使用するためログインすることによるセキュリティの心配はございません。
        </p>
      </div>
    </div>
  </div>

  <script>
    function enc(v){ return encodeURIComponent(String(v ?? '')); }
    function badge(el, on){
      el.textContent = on ? 'YT ON' : 'YT OFF';
      el.classList.remove('ok','warn');
      el.classList.add(on ? 'ok' : 'warn');
    }

    function showNotice({title, body, type, ms}){
      const el = document.getElementById('notice');
      const t = document.getElementById('notice-title');
      const b = document.getElementById('notice-body');
      if(!el || !t || !b) return;
      t.textContent = String(title || '通知');
      b.textContent = String(body || '');
      el.classList.remove('ok','warn','ng');
      el.classList.add(type === 'ok' ? 'ok' : (type === 'ng' ? 'ng' : 'warn'));
      el.classList.add('show');
      window.clearTimeout(showNotice._timer);
      const dur = Number.isFinite(ms) ? ms : 2600;
      showNotice._timer = window.setTimeout(()=>el.classList.remove('show'), Math.max(900, dur));
    }

    async function refresh(){
      const [authRes, ytRes] = await Promise.all([
        fetch('/api/auth/status', { cache: 'no-store' }),
        fetch('/api/yt/state', { cache: 'no-store' })
      ]);
      const auth = authRes.ok ? await authRes.json() : {};
      const yt = ytRes.ok ? await ytRes.json() : {};

      const enabled = !!yt.ytEnabled;
      badge(document.getElementById('badge-enabled'), enabled);

      const btn = document.getElementById('btn-toggle');
      btn.textContent = enabled ? 'コメント取得をOFFにする' : 'コメント取得をONにする';
      btn.disabled = false;

      document.getElementById('st-env').textContent = auth.oauthConfigured ? 'env OK' : 'env NG';
      document.getElementById('st-authed').textContent = auth.authed ? 'authed' : 'not authed';
      document.getElementById('st-channel').textContent = yt.authedChannel ? `${yt.authedChannel.title || '(no title)'} (${yt.authedChannel.id || '?'})` : '-';
      document.getElementById('st-live').textContent = yt.activeBroadcast ? `${yt.activeBroadcast.title || '(no title)'} (${yt.activeBroadcast.id || '?'})` : '-';
      document.getElementById('st-backoff').textContent = yt.backoffUntil || '-';
      const st = yt.lastStatus ? `${(yt.lastStatus.level || 'info').toUpperCase()}: ${yt.lastStatus.message || ''}` : '-';
      document.getElementById('st-status').textContent = st;

      // Small hint when OAuth isn't ready
      if(!auth.oauthConfigured){
        showNotice({ title: 'OAuth未設定', body: 'YT_CLIENT_ID / YT_CLIENT_SECRET / YT_REDIRECT_URL をRailwayに設定してください', type: 'warn', ms: 4200 });
      }
    }

    async function toggle(){
      let yt = {};
      try{
        yt = await (await fetch('/api/yt/state', { cache: 'no-store' })).json();
      } catch(_){
        showNotice({ title: 'エラー', body: '状態取得に失敗しました', type: 'ng' });
        return;
      }
      const enabled = !!yt.ytEnabled;
      const btn = document.getElementById('btn-toggle');
      btn.disabled = true;
      try{
        const r = await fetch('/api/yt/enabled', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ enabled: !enabled })
        });
        if(!r.ok){
          const txt = await r.text().catch(()=> '');
          showNotice({ title: '切り替え失敗', body: `YTを${!enabled ? 'ON' : 'OFF'}にできませんでした（${r.status}） ${txt}`.trim(), type: 'ng', ms: 5200 });
        } else {
          showNotice({ title: 'OK', body: `YTを${!enabled ? 'ON' : 'OFF'}にしました`, type: 'ok' });
        }
      } catch(e){
        showNotice({ title: '切り替え失敗', body: String(e?.message || e), type: 'ng', ms: 5200 });
      } finally {
        btn.disabled = false;
      }
      await refresh().catch(()=>{});
    }

    async function loadSavedSettings(){
      try{
        const r = await fetch('/api/settings', { cache: 'no-store' });
        if(!r.ok) return;
        const s = await r.json();
        if(s && typeof s === 'object'){
          if(typeof s.announce === 'string') document.getElementById('f-announce').value = s.announce;
          if(typeof s.xid === 'string') document.getElementById('f-xid').value = s.xid;
          if(typeof s.fanart === 'string') document.getElementById('f-fanart').value = s.fanart;
          if(typeof s.logo === 'string') document.getElementById('f-logo').value = s.logo;
          if(typeof s.logoZoom !== 'undefined' && s.logoZoom !== null) document.getElementById('f-logoZoom').value = String(s.logoZoom);
          if(typeof s.chat === 'string') document.getElementById('f-chat').value = s.chat;
        }
        showNotice({ title: '設定ロード', body: '保存済み設定を読み込みました', type: 'ok' });
      } catch(_){
        showNotice({ title: '設定ロード失敗', body: '保存済み設定の読み込みに失敗しました', type: 'ng', ms: 5200 });
      }
    }

    async function saveSettings(){
      const btn = document.getElementById('btn-save');
      btn.disabled = true;
      try{
        const body = {
          announce: document.getElementById('f-announce').value,
          xid: document.getElementById('f-xid').value,
          fanart: document.getElementById('f-fanart').value,
          logo: document.getElementById('f-logo').value,
          logoZoom: document.getElementById('f-logoZoom').value,
          chat: document.getElementById('f-chat').value,
        };
        const r = await fetch('/api/settings', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });
        if(!r.ok){
          const txt = await r.text().catch(()=> '');
          throw new Error(`save failed (${r.status}) ${txt}`.trim());
        }
        showNotice({ title: '保存OK', body: '設定を保存しました（配信画面をリロードすると反映されます）', type: 'ok', ms: 3600 });
      } catch(e){
        showNotice({ title: '保存失敗', body: String(e?.message || e), type: 'ng', ms: 5200 });
      } finally {
        btn.disabled = false;
      }
    }

    async function uploadLogo(){
      const fileInput = document.getElementById('f-logoFile');
      const btn = document.getElementById('btn-upload-logo');
      const file = fileInput?.files?.[0];
      if(!file){
        showNotice({ title: 'アップロード', body: '画像ファイルを選択してください', type: 'warn' });
        return;
      }
      btn.disabled = true;
      try{
        const fd = new FormData();
        fd.append('logo', file);
        const r = await fetch('/api/upload/logo', { method: 'POST', body: fd });
        let payloadText = '';
        try{ payloadText = await r.text(); } catch(_){ payloadText = ''; }
        let j = null;
        try{ j = payloadText ? JSON.parse(payloadText) : null; } catch(_){ j = null; }

        if(!r.ok || !j?.ok || !j?.url){
          const detail = j ? JSON.stringify(j) : payloadText;
          throw new Error(`upload failed (${r.status}) ${detail}`.trim());
        }
        document.getElementById('f-logo').value = `${location.origin}${j.url}`;
        showNotice({ title: 'アップロードOK', body: 'ロゴURLに反映しました。必要なら「この内容を保存」を押してください。', type: 'ok', ms: 3800 });
      } catch(e){
        showNotice({ title: 'アップロード失敗', body: String(e?.message || e), type: 'ng', ms: 5200 });
      } finally {
        btn.disabled = false;
      }
    }

    function buildUrl(preview){
      const base = `${location.origin}/`;
      const announce = document.getElementById('f-announce').value.trim();
      const xid = document.getElementById('f-xid').value.trim();
      const fanart = document.getElementById('f-fanart').value.trim();
      const logo = document.getElementById('f-logo').value.trim();
      const logoZoom = document.getElementById('f-logoZoom').value.trim();
      const chat = document.getElementById('f-chat').value.trim();

      const params = [];
      if(preview) params.push('preview=1');
      if(announce) params.push(`announce=${enc(announce)}`);
      if(xid) params.push(`xid=${enc(xid)}`);
      if(fanart) params.push(`fanart=${enc(fanart)}`);
      if(logo) params.push(`logo=${enc(logo)}`);
      if(logoZoom) params.push(`logoZoom=${enc(logoZoom)}`);
      if(chat) params.push(`chat=${enc(chat)}`);
      return base + (params.length ? `?${params.join('&')}` : '');
    }

    function setGenerated(url){
      const out = document.getElementById('out-url');
      out.value = url;
      document.getElementById('btn-open').disabled = !url;
      document.getElementById('btn-copy').disabled = !url;
    }

    // Initial load
    loadSavedSettings().catch(()=>{});

    document.getElementById('btn-toggle').addEventListener('click', ()=>toggle().catch(()=>{}));

    document.getElementById('btn-build').addEventListener('click', ()=>{
      setGenerated(buildUrl(false));
      showNotice({ title: 'URL生成', body: 'URLを生成しました', type: 'ok', ms: 1800 });
    });

    document.getElementById('btn-save').addEventListener('click', ()=>{
      saveSettings().then(()=>{
        // saved; keep quiet (no-alert) for OBS-friendly UI
      }).catch(()=>{});
    });

    document.getElementById('btn-upload-logo').addEventListener('click', ()=>{
      uploadLogo().catch(()=>{});
    });

    document.getElementById('btn-open').addEventListener('click', ()=>{
      const url = document.getElementById('out-url').value;
      if(url) window.open(url, '_blank', 'noopener');
    });

    document.getElementById('btn-copy').addEventListener('click', async ()=>{
      const url = document.getElementById('out-url').value;
      if(!url) return;
      try{
        await navigator.clipboard.writeText(url);
      } catch(_){
        // Fallback: select
        const out = document.getElementById('out-url');
        out.focus();
        out.select();
        document.execCommand('copy');
      }
    });

    refresh().catch(()=>{});
    setInterval(()=>refresh().catch(()=>{}), 2500);
  </script>
</body>
</html>
